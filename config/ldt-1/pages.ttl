@prefix elmo: <http://bp4mc2.org/elmo/def#>.
@prefix stage: <http://localhost:8080/bp4mc2/stage#>.
@prefix page: <http://bp4mc2.org/id/page#>.
@prefix style: <http://bp4mc2.org/id/style#>.
@prefix container-local: <http://localhost:8080/bp4mc2/container/>.
@prefix skos: <http://www.w3.org/2004/02/skos/core#>.
@prefix sh: <http://www.w3.org/ns/shacl#>.
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>.
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>.

style:nodeshape a elmo:Part;
	elmo:fragment [
		elmo:applies-to elmo:subject;
		elmo:appearance elmo:HiddenAppearance;
	];
	elmo:fragment [
		elmo:applies-to rdf:type;
		elmo:appearance elmo:HiddenAppearance;
	];
	elmo:fragment [
		elmo:applies-to sh:name;
		elmo:appearance elmo:HiddenAppearance;
	];
	elmo:fragment [
		elmo:applies-to rdfs:label;
		rdfs:label "Label"@nl;
		rdfs:label "Label"@en;
		elmo:index "1";
	];
	elmo:fragment [
		elmo:applies-to sh:targetClass;
		rdfs:label "Klasse"@nl;
		rdfs:label "Class"@en;
		elmo:index "2";
	];
	elmo:fragment [
		elmo:applies-to rdfs:comment;
		rdfs:label "Uitleg"@nl;
		rdfs:label "Description"@en;
		elmo:index "3";
	];
	elmo:fragment [
		elmo:applies-to skos:example;
		rdfs:label "Voorbeeld"@nl;
		rdfs:label "Example"@en;
		elmo:index "4";
	];
	elmo:fragment [
		elmo:applies-to sh:property;
		rdfs:label "Eigenschappen en relaties"@nl;
		rdfs:label "Properties en relations"@en;
		elmo:index "5";
	];
	elmo:query stage:nodeshape-query;
.
style:datatype-properties a elmo:Part;
	elmo:fragment [
		elmo:applies-to elmo:subject;
		elmo:appearance elmo:HiddenAppearance;
	];
	elmo:fragment [
		elmo:applies-to rdf:type;
		elmo:appearance elmo:HiddenAppearance;
	];
	elmo:fragment [
		elmo:applies-to sh:name;
		elmo:appearance elmo:HiddenAppearance;
	];
	elmo:fragment [
		elmo:applies-to sh:severity;
		elmo:appearance elmo:HiddenAppearance;
	];
	elmo:fragment [
		elmo:applies-to sh:message;
		elmo:appearance elmo:HiddenAppearance;
	];
	elmo:fragment [
		elmo:applies-to rdfs:label;
		rdfs:label "Label"@nl;
		rdfs:label "Label"@en;
		elmo:index "1";
	];
	elmo:fragment [
		elmo:applies-to sh:path;
		rdfs:label "Eigenschap"@nl;
		rdfs:label "Property"@en;
		elmo:index "2";
	];
	elmo:fragment [
		elmo:applies-to sh:class;
		rdfs:label "Verwijst naar"@nl;
		rdfs:label "Refers to"@en;
		elmo:index "3";
	];
	elmo:fragment [
		elmo:applies-to rdfs:comment;
		rdfs:label "Uitleg"@nl;
		rdfs:label "Description"@en;
		elmo:index "4";
	];
	elmo:fragment [
		elmo:applies-to skos:example;
		rdfs:label "Voorbeeld"@nl;
		rdfs:label "Example"@en;
		elmo:index "5";
	];
	elmo:fragment [
		elmo:applies-to sh:minCount;
		rdfs:label "Min card."@nl;
		rdfs:label "Min card."@en;
		elmo:index "6";
	];
	elmo:fragment [
		elmo:applies-to sh:maxCount;
		rdfs:label "Max card."@nl;
		rdfs:label "Max card."@en;
		elmo:index "7";
	];
	elmo:query stage:datatype-properties-query;
.
style:object-properties a elmo:Part;
	elmo:fragment [
		elmo:applies-to elmo:subject;
		elmo:appearance elmo:HiddenAppearance;
	];
	elmo:fragment [
		elmo:applies-to rdf:type;
		elmo:appearance elmo:HiddenAppearance;
	];
	elmo:fragment [
		elmo:applies-to sh:name;
		elmo:appearance elmo:HiddenAppearance;
	];
	elmo:fragment [
		elmo:applies-to sh:severity;
		elmo:appearance elmo:HiddenAppearance;
	];
	elmo:fragment [
		elmo:applies-to sh:message;
		elmo:appearance elmo:HiddenAppearance;
	];
	elmo:fragment [
		elmo:applies-to rdfs:label;
		rdfs:label "Label"@nl;
		rdfs:label "Label"@en;
		elmo:index "1";
	];
	elmo:fragment [
		elmo:applies-to sh:path;
		rdfs:label "Eigenschap"@nl;
		rdfs:label "Property"@en;
		elmo:index "2";
	];
	elmo:fragment [
		elmo:applies-to sh:class;
		rdfs:label "Verwijst naar"@nl;
		rdfs:label "Refers to"@en;
		elmo:index "3";
	];
	elmo:fragment [
		elmo:applies-to sh:node;
		rdfs:label "Relatie met"@nl;
		rdfs:label "Related with"@en;
		elmo:index "4";
	];
	elmo:fragment [
		elmo:applies-to rdfs:comment;
		rdfs:label "Uitleg"@nl;
		rdfs:label "Description"@en;
		elmo:index "5";
	];
	elmo:fragment [
		elmo:applies-to skos:example;
		rdfs:label "Voorbeeld"@nl;
		rdfs:label "Example"@en;
		elmo:index "6";
	];
	elmo:fragment [
		elmo:applies-to sh:minCount;
		rdfs:label "Min card."@nl;
		rdfs:label "Min card."@en;
		elmo:index "7";
	];
	elmo:fragment [
		elmo:applies-to sh:maxCount;
		rdfs:label "Max card."@nl;
		rdfs:label "Max card."@en;
		elmo:index "8";
	];
	elmo:query stage:object-properties-query;
.

stage:page-topmodel a elmo:Representation;
	elmo:url-pattern "/query/topmodel(.md|.html|.ttl|xmd)$";
	elmo:query stage:page-query;
	rdfs:seeAlso page:topmodel;
.
stage:page-skos-ap-sc a elmo:Representation;
	elmo:url-pattern "/query/skos-ap-sc(.md|.html|.ttl|xmd)$";
	elmo:contains style:nodeshape;
	elmo:contains style:datatype-properties;
	elmo:contains style:object-properties;
	elmo:query stage:page-query;
	rdfs:seeAlso page:skos;
.
stage:page-frbr-ap-sc a elmo:Representation;
	elmo:url-pattern "/query/frbr-ap-sc(.md|.html|.ttl|xmd)$";
	elmo:contains style:nodeshape;
	elmo:contains style:datatype-properties;
	elmo:contains style:object-properties;
	elmo:query stage:page-query;
	rdfs:seeAlso page:frbr;
.
stage:page-skoslex-ap-sc a elmo:Representation;
	elmo:url-pattern "/query/skoslex-ap-sc(.md|.html|.ttl|xmd)$";
	elmo:contains style:nodeshape;
	elmo:contains style:datatype-properties;
	elmo:contains style:object-properties;
	elmo:query stage:page-query;
	rdfs:seeAlso page:skoslex;
.
stage:page-dcat-ap-sc a elmo:Representation;
	elmo:url-pattern "/query/dcat-ap-sc(.md|.html|.ttl|xmd)$";
	elmo:contains style:nodeshape;
	elmo:contains style:datatype-properties;
	elmo:contains style:object-properties;
	elmo:query stage:page-query;
	rdfs:seeAlso page:dcat;
.

stage:page-query a elmo:Query;
	elmo:query '''
		PREFIX elmo: <http://bp4mc2.org/elmo/def#>
		prefix dct: <http://purl.org/dc/terms/>
		prefix cnt: <http://www.w3.org/2011/content#>
		prefix xhtml: <http://www.w3.org/1999/xhtml/vocab#>
		CONSTRUCT {
			?page elmo:data ?part.
			?item rdf:first ?chars.
			?item rdf:rest ?rest.
			?item rdf:first ?first.
			?first xhtml:img ?img.
			?item rdf:first ?first3.
			?first3 xhtml:heading ?heading.
			?item rdf:first ?first4.
			?first4 elmo:contains ?ctable.
			?first4 elmo:subject ?ctablesubject.
			?item rdf:first ?first2.
			?first2 dct:hasPart ?subpart.
		}
		WHERE {
			GRAPH <@STAGE@> {
				<@REPRESENTATION@> rdfs:seeAlso ?page
			}
			GRAPH <http://localhost:8080/bp4mc2/container/pages> {
				?page dct:hasPart ?part.
				?part (rdf:rest|rdf:rest/rdf:first/dct:hasPart)* ?item.
#				?item (rdf:rest|rdf:rest/rdf:first/dct:hasPart) ?rest.
				?item rdf:rest ?rest.
				OPTIONAL {
					?item rdf:first ?first2.
					?first2 dct:hasPart ?subpart.
				}
				OPTIONAL {
					?item rdf:first/cnt:chars ?chars
					FILTER (lang(?chars)="@LANGUAGE@")
				}
				OPTIONAL {
					?item rdf:first ?first.
					?first xhtml:img ?img.
				}
				OPTIONAL {
					?item rdf:first ?first3.
					?first3 xhtml:heading ?heading.
					FILTER (lang(?heading)="@LANGUAGE@")
				}
				OPTIONAL {
					?item rdf:first ?first4.
					?first4 xhtml:stylesheet ?ctable.
					?first4 dct:subject ?ctablesubject.
				}
			}
		}
	'''
.

stage:nodeshape-query a elmo:query;
	elmo:query '''
		PREFIX sh: <http://www.w3.org/ns/shacl#>
		PREFIX elmo: <http://bp4mc2.org/elmo/def#>
		CONSTRUCT {
			?nodeshape elmo:subject ?nodeshape.
			?nodeshape ?p ?o.
			?o rdfs:label ?olabel.
			?nodeshape sh:targetClass ?class.
			?class rdfs:label ?classlabel
		}
		WHERE {
			BIND (iri(concat("http://localhost:8080/bp4mc2/container/",strbefore(strafter("@DOCSUBJECT@","query/"),".md"))) as ?graph)
			GRAPH ?graph {
				{
					?nodeshape ?p ?o
					FILTER (lang(?o)="@LANGUAGE@" || lang(?o)="")
				}
				UNION
				{
					?nodeshape ?p ?o.
					FILTER(isIRI(?o) && ?p!=sh:targetClass)
					OPTIONAL {
						?o rdfs:label ?olabel.
						FILTER (lang(?olabel)="@LANGUAGE@")
					}
					FILTER NOT EXISTS {
						?nodeshape ?p ?o.
						?o sh:path rdf:type
					}
				}
				UNION
				{
					?nodeshape sh:targetClass ?class.
					?nodeshape sh:name ?classlabel
				}
			}
		}
	''';
.

stage:datatype-properties-query a elmo:query;
	elmo:query '''
		PREFIX sh: <http://www.w3.org/ns/shacl#>
		PREFIX elmo: <http://bp4mc2.org/elmo/def#>
		CONSTRUCT {
			?pshape elmo:subject ?nodeshape.
			?pshape ?p ?o.
			?pshape sh:path ?property.
			?property rdfs:label ?propertylabel
		}
		WHERE {
			BIND (iri(concat("http://localhost:8080/bp4mc2/container/",strbefore(strafter("@DOCSUBJECT@","query/"),".md"))) as ?graph)
			GRAPH ?graph {
				{
					{
						?nodeshape sh:property ?pshape.
						?pshape ?p ?o
						FILTER (lang(?o)="@LANGUAGE@" || lang(?o)="")
					}
					UNION
					{
						?nodeshape sh:property ?pshape.
						?pshape ?p ?o.
						FILTER(isIRI(?o) && ?p!=sh:path)
						OPTIONAL {
							?o rdfs:label ?olabel.
							FILTER (lang(?olabel)="@LANGUAGE@" || lang(?olabel)="")
						}
					}
					UNION
					{
						?pshape sh:path ?property.
						?pshape sh:name ?propertylabel
					}
				}
				FILTER NOT EXISTS {
					?pshape sh:path rdf:type
				}
				FILTER EXISTS {
					?pshape sh:datatype ?datatype
				}
			}
		}
	''';
.

stage:object-properties-query a elmo:query;
	elmo:query '''
		PREFIX sh: <http://www.w3.org/ns/shacl#>
		PREFIX elmo: <http://bp4mc2.org/elmo/def#>
		CONSTRUCT {
			?pshape elmo:subject ?nodeshape.
			?pshape ?p ?o.
			?o rdfs:label ?olabel.
			?pshape sh:path ?property.
			?property rdfs:label ?propertylabel
		}
		WHERE {
			BIND (iri(concat("http://localhost:8080/bp4mc2/container/",strbefore(strafter("@DOCSUBJECT@","query/"),".md"))) as ?graph)
			GRAPH ?graph {
				{
					{
						?nodeshape sh:property ?pshape.
						?pshape ?p ?o
						FILTER (lang(?o)="@LANGUAGE@" || lang(?o)="")
					}
					UNION
					{
						?nodeshape sh:property ?pshape.
						?pshape ?p ?o.
						FILTER(isIRI(?o) && ?p!=sh:path)
						OPTIONAL {
							?o rdfs:label ?olabel.
							FILTER (lang(?olabel)="@LANGUAGE@" || lang(?olabel)="")
						}
					}
					UNION
					{
						?pshape sh:path ?property.
						?pshape sh:name ?propertylabel
					}
				}
				FILTER NOT EXISTS {
					?pshape sh:path rdf:type
				}
				FILTER NOT EXISTS {
					?pshape sh:datatype ?datatype
				}
			}
		}
	''';
.
