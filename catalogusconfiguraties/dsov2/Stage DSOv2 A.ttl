#
#
#
# PREFIXES
#
#
#

@prefix stage: 			  <http://data.acceptatie.pdok.nl/catalogus/dsov2/stage#>.
@prefix updatestage: 	<http://data.acceptatie.pdok.nl/catalogus/dsov2/update/>.
@prefix elmo: 			  <http://bp4mc2.org/elmo/def#>.
@prefix rdf: 		    	<http://www.w3.org/1999/02/22-rdf-syntax-ns#>.
@prefix rdfs: 		  	<http://www.w3.org/2000/01/rdf-schema#>.
@prefix xhtml: 	    	<http://www.w3.org/1999/xhtml/vocab#>.
@prefix container: 		<http://data.acceptatie.pdok.nl/catalogus/dsov2/container/>.
@prefix skos: 			  <http://www.w3.org/2004/02/skos/core#>.
@prefix skosax: 	  	<http://bp4mc2.org/skosax#>.
@prefix skoslex: 	  	<http://bp4mc2.org/def/skos-lex/>.
@prefix thes: 		  	<http://purl.org/iso25964/skos-thes#>.
@prefix dc: 		    	<http://purl.org/dc/elements/1.1/>.
@prefix dct: 	    		<http://purl.org/dc/terms/>.
@prefix dctype: 		  <http://purl.org/dc/dcmitype/>.
@prefix geosparql: 		<http://www.opengis.net/ont/geosparql#>.
@prefix sh: 		    	<http://www.w3.org/ns/shacl#>.
@prefix owl: 		    	<http://www.w3.org/2002/07/owl#>.
@prefix foaf: 	  		<http://xmlns.com/foaf/0.1/>.
@prefix prov: 	  		<http://www.w3.org/ns/prov#>.
@prefix brt: 		     	<http://brt.basisregistraties.overheid.nl/id/dataset/>.
@prefix vcard: 	  		<http://www.w3.org/2006/vcard/ns#>.
@prefix xsd: 		    	<http://www.w3.org/2001/XMLSchema#>.
@prefix iso: 		    	<http://id.loc.gov/vocabulary/iso639-1/>.
@prefix dcat: 	  		<http://www.w3.org/ns/dcat#>.
@prefix adms: 	  		<http://www.w3.org/ns/adms#>.
@prefix wdrs: 	  		<http://www.w3.org/2007/05/powder-s#>.
@prefix yed: 	    		<http://bp4mc2.org/yed#>.
@prefix sparql:       <http://www.w3.org/ns/sparql-service-description/>. 
#
#
#
# FRAMEWORK
#
#
#

#
#
#
# PAGINA'S (REPRESENTATIONS)
#
#
#

# Hoofdpagina beheer
stage:DSOv2Beheerpagina rdf:type elmo:Representation;
	elmo:url-pattern "/catalogus/dsov2/admin(|/)$";
	elmo:contains stage:DSOv2Beheermenu;
	elmo:appearance elmo:HtmlAppearance;
	elmo:data [
		rdfs:label "DSOv2";
		elmo:html "<div><p>U bent succesvol ingelogd op de beheerpagina.</p></div>"
	]
.


#
#
#
# HERBRUIKBARE PAGINA-ONDERDELEN (PARTS)
#
#
#

# Menubalk hoofdmenu
stage:DSOv2Menu a elmo:Part;
	elmo:appearance elmo:NavbarSearchAppearance;
  elmo:data [
    elmo:data [
      rdfs:label "Home";
      xhtml:link "/catalogus/dsov2";
      elmo:index "1"
    ];
    elmo:data [
      rdfs:label "Beheer";
      xhtml:link "/catalogus/dsov2/admin";
      elmo:index "2";
    ];
  ]
.


# Beheermenu
stage:DSOv2Beheermenu a elmo:Part;
	elmo:appearance elmo:NavbarSearchAppearance;
	elmo:data [
		elmo:data [
			rdfs:label "Beheer";
			xhtml:link "/catalogus/dsov2/admin";
			elmo:index "0";
		];
		elmo:data [ 
			rdfs:label "Home";
			elmo:index "1";
			xhtml:link "/catalogus/dsov2";
		];
		elmo:data [
			rdfs:label "Concepten";
			elmo:index "3";
			elmo:data [
				rdfs:label "Voer nieuw concept op";
				elmo:index "01";
				xhtml:link "/catalogus/dsov2/container/concept-post-ttl";
			];
			elmo:data [
				rdfs:label "Pas bestaand concept aan";
				elmo:index "02";
				xhtml:link "/catalogus/dsov2/container/concept-put-ttl";
			];
      elmo:data [
				rdfs:label "Vul bestaand concept aan";
				elmo:index "03";
				xhtml:link "/catalogus/dsov2/container/concept-add-ttl";
			];
      elmo:data [
				rdfs:label "Maak begrip bekend";
				elmo:index "04";
				xhtml:link "/catalogus/dsov2/update/concept-issue";
			];
      elmo:data [
				rdfs:label "Laat begrip in werking treden";
				elmo:index "05";
				xhtml:link "/catalogus/dsov2/update/concept-enact";
			];
		];
		elmo:data [
			rdfs:label "Acties";
			elmo:index "5";
			elmo:data [
				rdfs:label "Verwijder alle data";
				elmo:index "1";
				xhtml:link "/catalogus/dsov2/update/clearalldata";
			];
			elmo:data [
				rdfs:label "Verwijder enkel concept";
				elmo:index "2";
				xhtml:link "/catalogus/dsov2/update/clearsingleconcept";
			];
      elmo:data [
				rdfs:label "Voer TomcatUser op";
				elmo:index "3";
				xhtml:link "/catalogus/dsov2/update/insert-tomcatuser";
			];
		];
	]
. 
#
#
#
# BEHEER CONCEPTEN
#
#
#

#
# CONTAINERS
#

# Twee soorten containers:
# POST
# 	- Voegt Ã©Ã©n of meerdere nieuwe begrippen toe
# 	- Geeft een foutmelding als Ã©Ã©n of meerdere van de geuploade begrippen al bestaan
# PUT
# 	- Update bestaande begrippen
#	- Geeft een foutmelding als Ã©Ã©n of meerdere van de geuploade begrippen nog niet bestaan
# 

# Upload Turtle API ------------------------------------------------------------------------------------------------------------------------------

# Container POST Turtle Concepten
container:concept-post-ttl a elmo:Container;
  # Onderdelen
  elmo:contains stage:DSOv2Beheermenu;
  
  # Weergave
  elmo:representation elmo:UploadRepresentation;
  rdfs:label "Voeg nieuw concept toe (.ttl)";
  
  # Data
  elmo:replaces container:generiek;
  elmo:query stage:DSOv2ConceptenPost;
.

# Container PUT Turtle Concepten
container:concept-put-ttl a elmo:Container;
  # Onderdelen
  elmo:contains stage:DSOv2Beheermenu;
  
  # Weergave
  elmo:representation elmo:UploadRepresentation;
  rdfs:label "Update bestaand concept (.ttl)";
  
  # Data
  elmo:replaces container:generiek;
  elmo:query stage:DSOv2ConceptenPut;
.

# Container voor aanvullen concept
container:concept-add-ttl a elmo:Container;
  # Onderdelen
  elmo:contains stage:DSOv2Beheermenu;
  
  # Weergave
  elmo:representation elmo:UploadRepresentation;
  rdfs:label "Vul bestaand concept aan (.ttl)";
  
  # Data
  elmo:replaces container:generiek;
  elmo:query stage:DSOv2ConceptenAdd;
.

#
# SCENES
#

stage:DSOv2ConceptenPost a elmo:Scene;
	rdfs:label "Query voor verwerken POST";
	elmo:query '''
		prefix prov: <http://www.w3.org/ns/prov#>
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix adms: <http://www.w3.org/ns/adms#>
		prefix sparql: <http://www.w3.org/ns/sparql-service-description/>
    prefix adms-status: <http://purl.org/adms/status/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    prefix wdrs: <http://www.w3.org/2007/05/powder-s#>
    
    prefix container: <http://data.acceptatie.pdok.nl/catalogus/dsov2/container/>
    prefix user: <http://omgevingswet.overheid.nl/catalogus/users/>
    
    INSERT {
      GRAPH ?transactie {
        ?transactie rdf:type sparql:Graph;
          rdfs:label "Reserveren van het begrip in de Catalogus";
          prov:generatedAtTime ?now
        .
        
        ?subject ?p ?o;
          wdrs:describedBy ?doc
        .
        
        ?doc rdf:type prov:Entity;
          adms:status adms-status:UnderDevelopment;
          prov:wasGeneratedBy ?activity
        .
        
        ?activity rdf:type prov:Activity;
          rdfs:label "Opvoeren nieuw begrip";
          prov:startedAtTime ?now;
          prov:wasAssociatedWith user:TomcatUser
        .
      }
    }
    WHERE {
      GRAPH container:generiek {
        ?s rdf:type skos:Concept;
          skos:prefLabel ?prefLabel;
          ?p ?o
        .
      }
      
      BIND( iri( concat( "http://omgevingswet.overheid.nl/catalogus/id/transactie/", replace( now(), " ", "T" ) ) ) AS ?transactie )
      BIND( iri( concat( "http://omgevingswet.overheid.nl/catalogus/id/activiteit/Opvoering_", replace( now(), " ", "T" ) ) ) AS ?activity )
      BIND( iri( concat( "http://regelgeving.omgevingswet.overheid.nl/id/concept/", ?prefLabel ) ) AS ?subject )
      BIND( iri ( concat(  "http://regelgeving.omgevingswet.overheid.nl/doc/", replace( now(), " ", "T" ), "/concept/", ?prefLabel ) ) AS ?doc )
      BIND( now() AS ?now )
    }
    
		CLEAR GRAPH container:generiek
    CLEAR GRAPH container:concept-post-ttl
	''';
.

stage:DSOv2ConceptenPut a elmo:Scene;
	rdfs:label "Query voor verwerken PUT";
	elmo:query '''
		prefix prov: <http://www.w3.org/ns/prov#>
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix adms: <http://www.w3.org/ns/adms#>
		prefix sparql: <http://www.w3.org/ns/sparql-service-description/>
    prefix adms-status: <http://purl.org/adms/status/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    prefix wdrs: <http://www.w3.org/2007/05/powder-s#>
    
    prefix container: <http://data.acceptatie.pdok.nl/catalogus/dsov2/container/>
    prefix user: <http://omgevingswet.overheid.nl/catalogus/users/>
		
    INSERT {
      GRAPH ?transactie {
        ?transactie rdf:type sparql:Graph;
          rdfs:label "Aanpassing van het begrip door het bevoegde gezag";
          prov:generatedAtTime ?now
        .
        
        ?s ?p ?o;
          wdrs:describedBy ?doc
        .
        
        ?doc rdf:type prov:Entity;
          adms:status adms-status:UnderDevelopment;
          prov:wasRevisionOf ?currentDoc;
          prov:wasGeneratedBy ?activity
        .
        
        ?udDoc ?docP ?docO;
          adms:status adms-status:Deprecated
        .
        
        ?activity rdf:type prov:Activity;
          rdfs:label "Aanpassen bestaand begrip (binnen besluit)";
          prov:startedAtTime ?now;
          prov:wasAssociatedWith user:TomcatUser
        .
      }
    }
    WHERE {
      GRAPH container:generiek {
        ?s ?p ?o.
      }
      GRAPH ?graph {       
        ?s wdrs:describedBy ?currentDoc;
          skos:prefLabel ?prefLabel.
        
        ?graph prov:generatedAtTime ?graphTime.
        FILTER NOT EXISTS {
          GRAPH ?newerGraph {
            ?newerGraph prov:generatedAtTime ?newerTime.
            ?s rdf:type skos:Concept.
            FILTER( ?newerTime > ?graphTime )
          }
        }
      }
      FILTER regex( ?graph, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
      
      OPTIONAL {
        GRAPH ?udGraph {
          ?s wdrs:describedBy ?udDoc.
          ?udDoc ?docP ?docO;
            adms:status adms-status:UnderDevelopment.
          FILTER( ?docP != adms:status )
          
          ?udGraph prov:generatedAtTime ?udGraphTime.       
          FILTER NOT EXISTS {
            GRAPH ?newerDocGraph {
              ?udDoc rdf:type prov:Entity.
              ?newerDocGraph prov:generatedAtTime ?newerDocGraphTime.
              FILTER ( ?newerDocGraphTime > ?udGraphTime )            
            }
          }
        }
        FILTER regex( ?udGraph, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
      }
      
      BIND( iri( concat( "http://omgevingswet.overheid.nl/catalogus/id/transactie/", replace( now(), " ", "T" ) ) ) AS ?transactie )
      BIND( iri( concat( "http://omgevingswet.overheid.nl/catalogus/id/activiteit/Aanpassing_", replace( now(), " ", "T" ) ) ) AS ?activity )
      BIND( iri ( concat(  "http://regelgeving.omgevingswet.overheid.nl/doc/", replace( now(), " ", "T" ), "/concept/", ?prefLabel ) ) AS ?doc )
      BIND( now() AS ?now )
    }
    
    CLEAR GRAPH container:generiek
    CLEAR GRAPH container:concept-put-ttl
  '''
.

stage:DSOv2ConceptenAdd a elmo:Scene;
	rdfs:label "Query voor verwerken aanvullen concept";
	elmo:query '''
		prefix prov: <http://www.w3.org/ns/prov#>
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix adms: <http://www.w3.org/ns/adms#>
		prefix sparql: <http://www.w3.org/ns/sparql-service-description/>
    prefix adms-status: <http://purl.org/adms/status/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    prefix wdrs: <http://www.w3.org/2007/05/powder-s#>
    
    prefix container: <http://data.acceptatie.pdok.nl/catalogus/dsov2/container/>
    prefix user: <http://omgevingswet.overheid.nl/catalogus/users/>
		
    INSERT {
      GRAPH ?transactie {
        ?transactie rdf:type sparql:Graph;
          rdfs:label "Aanvullen van een in werking zijnde begrip met buiten-besluit elementen";
          prov:generatedAtTime ?now
        .
        
        ?s ?p ?o;
          wdrs:describedBy ?doc;
          ?pred ?obj
        .
        
        ?doc ?docP ?docO;
          prov:wasRevisionOf ?currentDoc;
          prov:wasGeneratedBy ?activity
        .
        
        ?activity rdf:type prov:Activity;
          rdfs:label "Aanpassen bestaand begrip (buiten besluit)";
          prov:startedAtTime ?now;
          prov:wasAssociatedWith user:TomcatUser
        .
      }
    }
    WHERE {
      GRAPH container:generiek {
        ?s ?p ?o.
        
        FILTER(
          ?p != rdf:type
          && ?p != rdfs:label
          && ?p != skos:prefLabel
          && ?p != skos:definition
        )
      }
      GRAPH ?graph {
        ?s wdrs:describedBy ?currentDoc;
          skos:prefLabel ?prefLabel;
          ?pred ?obj
        .
        FILTER(
          ?pred != wdrs:describedBy
        )
          
        ?graph prov:generatedAtTime ?graphTime.
        FILTER NOT EXISTS {
          GRAPH ?newerGraph {
            ?newerGraph prov:generatedAtTime ?newerTime.
            ?s rdf:type skos:Concept;
              wdrs:describedBy ?newerDoc.
            FILTER( ?newerTime > ?graphTime )
          }
          GRAPH ?docNewerGraph {
            ?newerDoc adms:status skos-lex-status:Enacted
          }
        }
      }
      GRAPH ?docGraph {
        ?currentDoc adms:status skos-lex-status:Enacted;
          ?docP ?docO.
        FILTER (
          ?docP != prov:wasRevisionOf
          && ?docP != prov:wasGeneratedBy
        )
        
        ?docGraph prov:generatedAtTime ?docGraphTime.
        FILTER NOT EXISTS {
          GRAPH ?newerDocGraph {
            ?thisDoc adms:status skos-lex-status:Enacted.
            ?newerDocGraph prov:generatedAtTime ?newerDocGraphTime.
            FILTER( ?newerDocGraphTime > ?docGraphTime )
          }
        }
      }
      
      FILTER regex( ?graph, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
      
      BIND( iri( concat( "http://omgevingswet.overheid.nl/catalogus/id/transactie/", replace( now(), " ", "T" ) ) ) AS ?transactie )
      BIND( iri( concat( "http://omgevingswet.overheid.nl/catalogus/id/activiteit/Aanpassing_", replace( now(), " ", "T" ) ) ) AS ?activity )
      BIND( iri ( concat(  "http://regelgeving.omgevingswet.overheid.nl/doc/", replace( now(), " ", "T" ), "/concept/", ?prefLabel ) ) AS ?doc )
      BIND( now() AS ?now )
    }
    
    CLEAR GRAPH container:generiek
    CLEAR GRAPH container:concept-add-ttl
  '''
. 
#
#
#
# LIFECYCLE CONCEPTEN
#
#
#

#
# PRODUCTIONS
#

# Production om concept te selecteren en vervolgens bekend te maken
updatestage:concept-issue a elmo:Production;
	elmo:contains stage:DSOv2Beheermenu;
	elmo:contains stage:search-concepts-under-development;
	elmo:queryForm stage:DSOv2IssueConceptsForm;
	elmo:contains stage:IssueConceptScene;
.

updatestage:concept-enact a elmo:Production;
  elmo:contains stage:DSOv2Beheermenu;
	elmo:contains stage:search-concepts-nonenacted;
	elmo:queryForm stage:DSOv2EnactConceptsForm;
	elmo:contains stage:EnactConceptScene
.

#
# FORMS
#

stage:DSOv2IssueConceptsForm a elmo:Form;
	rdfs:label "Selecteer concept";
	elmo:index "1";
	elmo:fragment [
		elmo:applies-to "concept";
		rdfs:label "Selecteer concept"@nl;
		elmo:valuesFrom stage:search-concepts-under-development;
		elmo:constraint elmo:MandatoryConstraint;
		elmo:index "1";
	];
	elmo:fragment [
		elmo:appearance elmo:SubmitAppearance;
		rdfs:label "Ga verder"@nl;
		elmo:index "2";
	];
.

stage:DSOv2EnactConceptsForm a elmo:Form;
	rdfs:label "Selecteer concept";
	elmo:index "1";
	elmo:fragment [
		elmo:applies-to "graph";
		rdfs:label "Selecteer concept"@nl;
		elmo:valuesFrom stage:search-concepts-nonenacted;
		elmo:constraint elmo:MandatoryConstraint;
		elmo:index "1";
	];
	elmo:fragment [
		elmo:appearance elmo:SubmitAppearance;
		rdfs:label "Ga verder"@nl;
		elmo:index "3";
	];
.

#
# PARTS
#

stage:search-concepts-under-development a elmo:Part;
	elmo:appearance elmo:HiddenAppearance;
	elmo:query '''
		prefix prov: <http://www.w3.org/ns/prov#>
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix adms: <http://www.w3.org/ns/adms#>
		prefix sparql: <http://www.w3.org/ns/sparql-service-description>
    prefix adms-status: <http://purl.org/adms/status/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    prefix wdrs: <http://www.w3.org/2007/05/powder-s#>
    
		CONSTRUCT {
			?concept rdfs:label ?label
		}
		WHERE {
			GRAPH ?g {
				?concept rdf:type skos:Concept;
          wdrs:describedBy ?doc.
          
        ?doc adms:status adms-status:UnderDevelopment.
    		BIND( str(?concept) AS ?label )

        ?docGraph prov:generatedAtTime ?docGraphTime.       
        FILTER NOT EXISTS {
          GRAPH ?newerDocGraph {
            ?doc rdf:type prov:Entity.
            ?newerDocGraph prov:generatedAtTime ?newerDocGraphTime.
            FILTER ( ?newerDocGraphTime > ?docGraphTime )            
          }
        }
			}
      FILTER regex( ?g, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
		}
	''';
.

stage:search-concepts-nonenacted a elmo:Part;
	elmo:appearance elmo:HiddenAppearance;
	elmo:query '''
		prefix prov: <http://www.w3.org/ns/prov#>
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix adms: <http://www.w3.org/ns/adms#>
		prefix sparql: <http://www.w3.org/ns/sparql-service-description>
    prefix adms-status: <http://purl.org/adms/status/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    prefix wdrs: <http://www.w3.org/2007/05/powder-s#>
    
		CONSTRUCT {
			?g rdfs:label ?label
		}
		WHERE {
      GRAPH ?g {
        ?concept rdf:type skos:Concept;
          wdrs:describedBy ?doc.
      }
      FILTER regex( ?g, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
      GRAPH ?docGraph {
        ?doc rdf:type prov:Entity;
          adms:status ?status.
        
        FILTER(
          ?status != skos-lex-status:Enacted 
          && ?status != adms-status:Deprecated
        )
        
        ?docGraph prov:generatedAtTime ?docGraphTime.       
        FILTER NOT EXISTS {
          GRAPH ?newerDocGraph {
            ?doc rdf:type prov:Entity.
            ?newerDocGraph prov:generatedAtTime ?newerDocGraphTime.
            FILTER ( ?newerDocGraphTime > ?docGraphTime )            
          }
        }
      }
      BIND( concat( str( ?concept ), " (", ?status, ")" ) AS ?label )
		}
	''';
.


#
# SCENES
#

stage:IssueConceptScene a elmo:Scene;
	elmo:index "1";
	rdfs:label "Maak begrip bekend";
	elmo:query '''
    prefix prov: <http://www.w3.org/ns/prov#>
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix adms: <http://www.w3.org/ns/adms#>
		prefix sparql: <http://www.w3.org/ns/sparql-service-description/>
    prefix adms-status: <http://purl.org/adms/status/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    prefix wdrs: <http://www.w3.org/2007/05/powder-s#>
    prefix dcterms: <http://purl.org/dc/terms/>
    
    prefix container: <http://data.acceptatie.pdok.nl/catalogus/dsov2/container/>
    prefix user: <http://omgevingswet.overheid.nl/catalogus/users/>
		
    INSERT {
      GRAPH ?transactie {      
        ?transactie rdf:type sparql:Graph;
          rdfs:label "Bekendmaking van het begrip in de LVBB, en de registratie hiervan in de Catalogus";
          prov:generatedAtTime ?now
        .

        ?doc rdf:type prov:Entity;
          prov:wasRevisionOf ?prevDoc;
          adms:status skos-lex-status:Issued;
          dcterms:issued ?date;
          prov:wasGeneratedBy ?activity
        .
        
        ?activity rdf:type prov:Activity;
          rdfs:label "Bekendmaking van het begrip";
          prov:startedAtTime ?now;
          prov:wasAssociatedWith user:TomcatUser
        .
      }
    }
    WHERE {
      GRAPH ?graph {
        <@CONCEPT@> wdrs:describedBy ?doc.
      }
      FILTER regex( ?graph, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
      OPTIONAL {
        GRAPH ?docGraph {
          ?doc prov:wasRevisionOf ?prevDoc.
        }
        FILTER regex( ?graph, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
      }
      FILTER NOT EXISTS {
        ?newdoc prov:wasRevisionOf ?doc.
      }
      
      BIND( strdt( concat(  year( now() ), "-", month( now() ), "-", day( now() ) ), xsd:date ) AS ?date )
      BIND( iri( concat( "http://omgevingswet.overheid.nl/catalogus/id/transactie/", replace( now(), " ", "T" ) ) ) AS ?transactie )
      BIND( iri( concat( "http://omgevingswet.overheid.nl/catalogus/id/activiteit/Bekendmaking_", replace( now(), " ", "T" ) ) ) AS ?activity )
      BIND( now() AS ?now )
    }
	'''
.

stage:EnactConceptScene a elmo:Scene;
	elmo:index "3";
	rdfs:label "Laat gekozen versie van concept in werking treden";
	elmo:query '''
    prefix prov: <http://www.w3.org/ns/prov#>
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix adms: <http://www.w3.org/ns/adms#>
		prefix sparql: <http://www.w3.org/ns/sparql-service-description/>
    prefix adms-status: <http://purl.org/adms/status/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    prefix wdrs: <http://www.w3.org/2007/05/powder-s#>
    prefix dcterms: <http://purl.org/dc/terms/>
    
    prefix container: <http://data.acceptatie.pdok.nl/catalogus/dsov2/container/>
    prefix user: <http://omgevingswet.overheid.nl/catalogus/users/>
		
    INSERT {
      GRAPH ?transactie {      
        ?transactie rdf:type sparql:Graph;
          rdfs:label "In werkingtreding van het begrip";
          prov:generatedAtTime ?now
        .

        ?doc ?p ?o;
          adms:status skos-lex-status:Enacted;
          dcterms:issued ?issuedDate;
          dcterms:valid ?validDate;
          prov:wasGeneratedBy ?activity
        .
        
        ?prevDoc ?prevP ?prevO;
          dcterms:valid ?newValidDate
        .
        
        ?activity rdf:type prov:Activity;
          rdfs:label "In werkingtreding van het begrip";
          prov:startedAtTime ?now;
          prov:wasAssociatedWith user:TomcatUser
        .
      }
    }
    WHERE {
      GRAPH <@GRAPH@> {
        ?doc rdf:type prov:Entity;
          ?p ?o.
        FILTER(
          ?p != adms:status
          && ?p != dcterms:issued
          && ?p != prov:wasGeneratedBy
        )
        OPTIONAL {
          ?doc dcterms:issued ?currentIssued.
        }
      }
      
      GRAPH ?currentTransaction {
        ?concept wdrs:describedBy ?doc.
      }
      OPTIONAL {
        GRAPH ?previousTransaction {
          ?concept wdrs:describedBy ?prevDoc.
        }
        GRAPH ?docGraph {
          ?prevDoc ?prevP ?prevO;
            dcterms:valid ?currentValidDate.
          BIND( concat( ?currentValidDate, year( now() ), "-", month( now() ), "-", day( now() ) ) AS ?newValidDate )
          FILTER regex( ?currentValidDate, ".*/$" )
          FILTER( ?prevP != dcterms:valid )
        }
      }
      
      BIND( iri( concat( "http://omgevingswet.overheid.nl/catalogus/id/transactie/", replace( now(), " ", "T" ) ) ) AS ?transactie )
      BIND( iri( concat( "http://omgevingswet.overheid.nl/catalogus/id/activiteit/In_werkingtreding_", replace( now(), " ", "T" ) ) ) AS ?activity )
      BIND( concat( year( now() ), "-", month( now() ), "-", day( now() ) , "/" ) AS ?validDate )
      BIND( now() AS ?now )
      BIND( IF( BOUND( ?currentIssued ), ?currentIssued, concat( year( now() ), "-", month( now() ), "-", day( now() ) ) ) AS ?issuedDate )
    }
	'''
. 
#
#
#
# LIFECYCLE CONCEPTEN
#
#
#

#
# PRODUCTIONS
#

# Production om concept te selecteren en vervolgens bekend te maken
updatestage:insert-tomcatuser a elmo:Production;
	elmo:contains stage:DSOv2Beheermenu;
	elmo:contains stage:InsertTomcatUserScene;
.

#
# SCENES
#

stage:InsertTomcatUserScene a elmo:Scene;
	elmo:index "1";
	rdfs:label "Maak begrip bekend";
	elmo:query '''
    prefix prov: <http://www.w3.org/ns/prov#>
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix adms: <http://www.w3.org/ns/adms#>
		prefix sparql: <http://www.w3.org/ns/sparql-service-description/>
    prefix adms-status: <http://purl.org/adms/status/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    prefix wdrs: <http://www.w3.org/2007/05/powder-s#>
    prefix dcterms: <http://purl.org/dc/terms/>
    
    prefix catalogus: <http://omgevingswet.overheid.nl/catalogus/>
    prefix user: <http://omgevingswet.overheid.nl/catalogus/users/>
		
    INSERT {
      GRAPH catalogus:users {
        user:TomcatUser rdf:type prov:Agent;
          rdfs:label "Tomcat User";
          foaf:givenName "Tomcat User";
          foaf:mbox "tomcat@user.org";
          prov:actedOnBehalfOf "Apache"
        .
      }
    }
	'''
. 
#
#
#
# CLEAR ALL DATA
#
#
#

#
# PRODUCTIONS
#

# Speciale pagina om alle gegevens te wissen
# Deze backdoor moet zeer waarschijnlijk verwijderd worden uit de definitieve configuratie!
updatestage:clearalldata a elmo:Production;
	elmo:contains stage:DSOv2Beheermenu;
	elmo:queryForm stage:DSOv2DummyForm;
	elmo:contains stage:ClearTransactions;
  elmo:contains stage:ClearContainers
.

# DummyForm nodig omdat anders de feedback vanuit de scenes niet getoond wordt
stage:DSOv2DummyForm a elmo:Form.


#
# SCENES
#

# Scene gebruikt voor het verwijderen van alle data
stage:ClearTransactions a elmo:Scene;
	elmo:index "1";
	rdfs:label "Verwijderen transacties";
	elmo:query '''
		prefix container: <http://data.acceptatie.pdok.nl/catalogus/dso/container/>
    
		DELETE {
			GRAPH ?g {
				?s ?p ?o
			}
		}
		WHERE {
			GRAPH ?g {
				?s ?p ?o
			}
			FILTER regex( ?g, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
		}
  '''
.

stage:ClearContainers a elmo:Scene;
  elmo:index "2";
  rdfs:label "Verwijderen containers";
  elmo:query '''
    DELETE {
			GRAPH ?g {
				?s ?p ?o
			}
		}
		WHERE {
			GRAPH ?g {
				?s ?p ?o
			}
			FILTER regex( ?g, "http://data.acceptatie.pdok.nl/catalogus/dsov2/" )
		}
	'''
.
 
#
#
#
# CLEAR ALL DATA
#
#
#

#
# PRODUCTIONS
#

# Speciale pagina om alle data over een enkel concept te wissen
# Deze backdoor moet zeer waarschijnlijk verwijderd worden uit de definitieve configuratie!
updatestage:clearsingleconcept a elmo:Production;
	elmo:contains stage:DSOv2Beheermenu;
	elmo:contains stage:search_concepts;
	elmo:queryForm stage:DSOv2SelectConceptForm;
	elmo:contains stage:ClearSingleConceptScene;
.

stage:DSOv2SelectConceptForm a elmo:Form;
	rdfs:label "Selecteer concept";
	elmo:index "1";
	elmo:fragment [
		elmo:applies-to "concept";
		rdfs:label "Selecteer concept"@nl;
		elmo:valuesFrom stage:search_concepts;
		elmo:constraint elmo:MandatoryConstraint;
		elmo:index "1";
	];
	elmo:fragment [
		elmo:appearance elmo:SubmitAppearance;
		rdfs:label "Ga verder"@nl;
		elmo:index "2";
	];
.

#
# PARTS
#

stage:search_concepts a elmo:Part;
	elmo:appearance elmo:HiddenAppearance;
	elmo:query '''
		prefix dcat: <http://www.w3.org/ns/dcat#>
		CONSTRUCT {
			?concept rdfs:label ?label
		}
		WHERE {
			GRAPH ?g {
				?concept rdf:type skos:Concept.
    		BIND( str(?concept) AS ?label )
			}
			FILTER regex( ?g, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
		}
	''';
.


#
# SCENES
#

# Scene gebruikt voor het verwijderen van alle data
stage:ClearSingleConceptScene a elmo:Scene;
	elmo:index "1";
	rdfs:label "Verwijder enkel concept";
	elmo:query '''
		DELETE {
			GRAPH ?g {
				<@CONCEPT@> ?p ?o
			}
		}
		WHERE {
			GRAPH ?g {
				<@CONCEPT@> ?p ?o
			}
      FILTER regex( ?g, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
		}
	'''
.
 
#
# PAGINA'S (REPRESENTATIONS)
#

# Weergavepagina inclusief versies en grafische weergave
stage:WeergavePaginaConcepten a elmo:Representation;
  # Bereikbaarheid
  elmo:uri-pattern "/id/concept/";
  elmo:applies-to [
		rdf:type skos:Concept
	];
  
  # Onderdelen
  elmo:contains stage:DSOv2Menu;
  
  # Data
	elmo:query stage:WeergaveTabelConceptenQuery;
.

# Query voor WeergaveTabel
stage:WeergaveTabelConceptenQuery a elmo:Query;
	elmo:query '''
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix dct: <http://purl.org/dc/terms/>
		prefix thes: <http://purl.org/iso25964/skos-thes#>
		prefix prov: <http://www.w3.org/ns/prov#>
		prefix dc: <http://purl.org/dc/terms/>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix container: <http://data.acceptatie.pdok.nl/catalogus/dsov2/container/>
		prefix doc: <http://data.acceptatie.pdok.nl/catalogus/dsov2/concepten/doc/>
		prefix dataset: <http://data.acceptatie.pdok.nl/catalogus/dsov2/id/dataset/>
		prefix concept: <http://data.acceptatie.pdok.nl/catalogus/dsov2/id/concept/>
		prefix brt: <http://brt.basisregistraties.overheid.nl/id/dataset/>
		prefix bp4mc2: <http://bp4mc2.org/elmo/def/>
		prefix dcat: <http://www.w3.org/ns/dcat#>
		prefix tr: <http://data.acceptatie.pdok.nl/toepasbareregels/>
		
		construct {
      ?graph prov:generatedAtTime ?time.
			?graph ?p ?o.
		}
		where {
      GRAPH ?graph {
        ?graph prov:generatedAtTime ?time.
        <@IDSUBJECT@> ?p ?o.
        FILTER( ?p != rdfs:label )
      }
      FILTER regex( ?graph, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
		}
	'''
. 
#
# PAGINA'S (REPRESENTATIONS)
#

# Weergavepagina inclusief versies en grafische weergave
stage:WeergavePaginaConceptenMetadata a elmo:Representation;
  # Bereikbaarheid
  elmo:applies-to [
		rdf:type prov:Entity
	];
  
  # Onderdelen
  elmo:contains stage:DSOv2Menu;
  
  # Data
	elmo:query stage:WeergaveTabelConceptenMetadataQuery;
.

# Query voor WeergaveTabel
stage:WeergaveTabelConceptenMetadataQuery a elmo:Query;
	elmo:query '''
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix dct: <http://purl.org/dc/terms/>
		prefix thes: <http://purl.org/iso25964/skos-thes#>
		prefix prov: <http://www.w3.org/ns/prov#>
		prefix dc: <http://purl.org/dc/terms/>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix container: <http://data.acceptatie.pdok.nl/catalogus/dsov2/container/>
		prefix doc: <http://data.acceptatie.pdok.nl/catalogus/dsov2/concepten/doc/>
		prefix dataset: <http://data.acceptatie.pdok.nl/catalogus/dsov2/id/dataset/>
		prefix concept: <http://data.acceptatie.pdok.nl/catalogus/dsov2/id/concept/>
		prefix brt: <http://brt.basisregistraties.overheid.nl/id/dataset/>
		prefix bp4mc2: <http://bp4mc2.org/elmo/def/>
		prefix dcat: <http://www.w3.org/ns/dcat#>
		prefix tr: <http://data.acceptatie.pdok.nl/toepasbareregels/>
		
		construct {
      ?graph prov:generatedAtTime ?time.
			?graph ?p ?o.
		}
		where {
      GRAPH ?graph {
        ?graph prov:generatedAtTime ?time.
        <@SUBJECT@> ?p ?o.
      }
      FILTER regex( ?graph, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
		}
	'''
. 
#
#
#
# WEERGAVEPAGINA'S
#
#
#

stage:WeergavePaginaActivity a elmo:Representation;
  # Bereikbaarheid
	elmo:applies-to [
		rdf:type prov:Activity;
	];
  
  # Onderdelen
  elmo:contains stage:DSOv2Menu;
  
  # Data
	elmo:query stage:WeergaveTabelActivityQuery;
.

stage:WeergavePaginaAgent a elmo:Representation;
  # Bereikbaarheid
	elmo:applies-to [
		rdf:type prov:Agent;
	];
  
  # Onderdelen
  elmo:contains stage:DSOv2Menu;
  
  # Data
	elmo:query stage:WeergaveTabelAgentQuery;
.

# Query voor WeergaveTabel
stage:WeergaveTabelActivityQuery a elmo:Query;
	elmo:query '''
		CONSTRUCT {
      <@IDSUBJECT@> ?p ?o
		}
		WHERE {
      GRAPH ?graph {
        <@IDSUBJECT@> ?p ?o.
      }
      FILTER regex( ?graph, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
		}
	'''
.

# Query voor WeergaveTabel
stage:WeergaveTabelAgentQuery a elmo:Query;
	elmo:query '''
		prefix catalogus: <http://omgevingswet.overheid.nl/catalogus/>
    
		CONSTRUCT {
      <@IDSUBJECT@> ?p ?o
		}
		WHERE {
      GRAPH catalogus:users {
        <@IDSUBJECT@> ?p ?o.
      }
		}
	'''
. 
#
#
#
# OVERZICHTSPAGINA
#
#
#

#
# PAGINA'S (REPRESENTATIONS)
#

# Overzichtspagina concepten
stage:DSOv2Overzichtspagina rdf:type elmo:Representation;
  # Bereikbaarheid
	elmo:url-pattern "/catalogus/dsov2(|/)$";
  
  # Onderdelen
  elmo:contains stage:DSOv2Menu;
  
  # Weergave
  elmo:appearance elmo:TableAppearance;
  
  # Data
  elmo:query stage:DSOv2ConceptenQuery;
.

#
# QUERY'S
#

# Query voor tonen alle concepten
stage:DSOv2ConceptenQuery a elmo:Query;
	elmo:query '''
		prefix prov: <http://www.w3.org/ns/prov#>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix container: <http://data.acceptatie.pdok.nl/catalogus/dsov2/container/>
		prefix doc: <http://data.acceptatie.pdok.nl/catalogus/dsov2/concepten/doc/>
		prefix collection: <http://data.acceptatie.pdok.nl/catalogus/dsov2/id/collection/>
		prefix concept: <http://data.acceptatie.pdok.nl/catalogus/dsov2/id/concept/>
		
		SELECT ?concept ?concept_label ?uitleg
		WHERE {
      GRAPH ?graph {
        ?concept rdf:type skos:Concept;
          rdfs:label ?concept_label.
        OPTIONAL {?concept skos:definition ?uitleg}
        
        ?graph prov:generatedAtTime ?graphTime.
        FILTER NOT EXISTS {
          GRAPH ?newerGraph {
            ?newerGraph prov:generatedAtTime ?newerTime.
            ?concept rdf:type skos:Concept.
            FILTER( ?newerTime > ?graphTime )
          }
        }
      }
      FILTER regex( ?graph, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
		}
		ORDER BY lcase(?concept_label)
	'''
.
 
