#
#
#
# BEHEER DATASETS
#
#
#

#
# CONTAINERS
#

# Uploadcontainer datasets
container:dataset-post-ttl a elmo:Container;
	elmo:contains stage:DSOv2Beheermenu;
	elmo:contains stage:DSOv2Header;
	elmo:contains stage:DSOv2Footer;
	elmo:representation elmo:UploadRepresentation;
	rdfs:label "Upload Dataset beschrijving (RDF of Turtle)";
  elmo:replaces container:generiek;
	elmo:query stage:DSOv2DatasetUploadScene;
	elmo:assertion [
		rdfs:label "De upload mag geen datasets zonder dct:title bevatten.";
		elmo:assert-not '''
			prefix container: <http://localhost:8080/catalogus/dsov2/container/>
			prefix dct: <http://purl.org/dc/terms/>
			ASK {
				GRAPH container:generiek {
					?s rdf:type ?type.
					FILTER NOT EXISTS {
						?s dct:title ?title.
					}
				}
			}
		''';
	];
	elmo:assertion [
		rdfs:label "De upload mag geen datasets zonder skos:ConceptScheme bevatten.";
		elmo:assert-not '''
			prefix container: <http://localhost:8080/catalogus/dsov2/container/>
			prefix dcat: <http://www.w3.org/ns/dcat#>
			ASK {
				GRAPH container:generiek {
					?s rdf:type ?type.
					FILTER NOT EXISTS {
						?s rdf:type skos:ConceptScheme.
					}
				}
			}
		''';
	];
	elmo:assertion [
		rdfs:label "De upload mag geen datasets zonder dcat:Dataset bevatten.";
		elmo:assert-not '''
			prefix container: <http://localhost:8080/catalogus/dsov2/container/>
			prefix dcat: <http://www.w3.org/ns/dcat#>
			ASK {
				GRAPH container:generiek {
					?s rdf:type ?type.
					FILTER NOT EXISTS {
						?s rdf:type dcat:Dataset.
					}
				}
			}
		''';
	];
.

#
# SCENES
#

# Uploadquery datasets
stage:DSOv2DatasetUploadScene a elmo:Scene;
	rdfs:label "Postquery inladen dataset-metadata";
	elmo:index "1";
	elmo:query '''
    prefix adms:            <http://www.w3.org/ns/adms#>
    prefix adms-status:     <http://purl.org/adms/status/>
    prefix dcat: 	  		    <http://www.w3.org/ns/dcat#>
    prefix dcterms:    		  <http://purl.org/dc/terms/>
    prefix def:             <http://catalogus.test.kadaster.nl/def/>
    prefix foaf: 	  		    <http://xmlns.com/foaf/0.1/>
    prefix org:             <http://www.w3.org/TR/vocab-org#>
    prefix prov:            <http://www.w3.org/ns/prov#>
    prefix sd:              <http://www.w3.org/ns/sparql-service-description/>
    prefix skos:            <http://www.w3.org/2004/02/skos/core#>
    prefix skoslex:         <http://bp4mc2.org/def/skos-lex/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    
    prefix container:       <http://localhost:8080/catalogus/dsov2/container/>
    prefix user:            <http://catalogus.test.kadaster.nl/users/>
    
    INSERT {
      GRAPH ?transactie {
        ?transactie rdf:type sd:Graph, prov:Entity;
          skos:changeNote "Reserveren van het dataset in de Catalogus";
          prov:generatedAtTime ?now;
          prov:wasAttributedTo user:TomcatUser
        .
        
        ?s ?p ?o;
          foaf:isPrimaryTopicOf ?doc
        .
        
        ?doc rdf:type prov:Entity;
          adms:status adms-status:UnderDevelopment
        .
      }
    }
    WHERE {
      GRAPH container:generiek {
        ?s rdf:type dcat:Dataset;
          dcterms:title ?title;
          ?p ?o
        .
      }
      
      BIND( iri( concat( "http://catalogus.test.kadaster.nl/id/transactie/", replace( now(), " ", "T" ) ) ) AS ?transactie )
      BIND( iri ( concat(  "http://catalogus.test.kadaster.nl/id/entity/", replace( now(), " ", "T" ), "-dataset-", replace( ?title, " ", "" ) ) ) AS ?doc )
      BIND( now() AS ?now )
    }
    
		CLEAR GRAPH container:dataset-post-ttl
    CLEAR GRAPH container:generiek
	''';
.
