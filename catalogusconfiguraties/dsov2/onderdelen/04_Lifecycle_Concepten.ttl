#
#
#
# LIFECYCLE CONCEPTEN
#
#
#

#
# PRODUCTIONS
#

# Speciale pagina om alle data over een enkel concept te wissen
# Deze backdoor moet zeer waarschijnlijk verwijderd worden uit de definitieve configuratie!
updatestage:concept-issue a elmo:Production;
	elmo:contains stage:DSOv2Beheermenu;
	elmo:contains stage:search-nonissued-concepts;
	elmo:queryForm stage:DSOv2SelectNonIssuedConceptForm;
	elmo:contains stage:IssueConceptScene;
.

stage:DSOv2SelectNonIssuedConceptForm a elmo:Form;
	rdfs:label "Selecteer concept";
	elmo:index "1";
	elmo:fragment [
		elmo:applies-to "concept";
		rdfs:label "Selecteer concept"@nl;
		elmo:valuesFrom stage:search-nonissued-concepts;
		elmo:constraint elmo:MandatoryConstraint;
		elmo:index "1";
	];
	elmo:fragment [
		elmo:appearance elmo:SubmitAppearance;
		rdfs:label "Ga verder"@nl;
		elmo:index "2";
	];
.

#
# PARTS
#

stage:search-nonissued-concepts a elmo:Part;
	elmo:appearance elmo:HiddenAppearance;
	elmo:query '''
		prefix prov: <http://www.w3.org/ns/prov#>
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix adms: <http://www.w3.org/ns/adms#>
		prefix sparql: <http://www.w3.org/ns/sparql-service-description>
    prefix adms-status: <http://purl.org/adms/status/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    prefix wdrs: <http://www.w3.org/2007/05/powder-s#>
    
		CONSTRUCT {
			?concept rdfs:label ?label
		}
		WHERE {
			GRAPH ?g {
				?concept rdf:type skos:Concept;
          wdrs:describedBy ?doc.
          
        ?doc adms:status adms-status:UnderDevelopment.
    		BIND( str(?concept) AS ?label )
			}
      FILTER regex( ?g, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
      FILTER NOT EXISTS {
        GRAPH ?docg {
          {
            ?newdoc prov:wasRevisionOf ?doc.
          }
          UNION
          {
            ?doc adms:status ?status.
            FILTER( ?status != adms-status:UnderDevelopment )
          }
        }
        FILTER regex( ?docg, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
      }
		}
	''';
.


#
# SCENES
#

# Scene gebruikt voor het verwijderen van alle data
stage:IssueConceptScene a elmo:Scene;
	elmo:index "1";
	rdfs:label "Maak begrip bekend";
	elmo:query '''
    prefix prov: <http://www.w3.org/ns/prov#>
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix adms: <http://www.w3.org/ns/adms#>
		prefix sparql: <http://www.w3.org/ns/sparql-service-description/>
    prefix adms-status: <http://purl.org/adms/status/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    prefix wdrs: <http://www.w3.org/2007/05/powder-s#>
    prefix dcterms: <http://purl.org/dc/terms/>
    
    prefix container: <http://localhost:8080/catalogus/dsov2/container/>
		prefix transactie: <http://omgevingswet.overheid.nl/catalogus/id/transactie/@CURRENTMOMENT@>
    
    INSERT {
      GRAPH transactie: {      
        transactie: rdf:type sparql:Graph;
          rdfs:label "Tweede opname (Bekendmaking van het begrip in de LVBB, en de registratie hiervan in de Catalogus)";
          prov:generatedAtTime "@CURRENTMOMENT@"^^xsd:dateTime.

        ?doc rdf:type prov:Entity;
          adms:status skos-lex-status:Issued;
          dcterms:issued concat(  year( now() ), "-",
                                  month( now() ), "-",
                                  day( now() ) )^^xsd:date.
      }
    }
    WHERE {
      <@CONCEPT@> wdrs:describedBy ?doc.
      FILTER NOT EXISTS {
        ?newdoc prov:wasRevisionOf ?doc.
      }
    }
	'''
.
