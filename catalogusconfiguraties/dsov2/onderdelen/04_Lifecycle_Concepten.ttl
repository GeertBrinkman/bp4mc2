#
#
#
# LIFECYCLE CONCEPTEN
#
#
#

#
# PRODUCTIONS
#

# Production om concept te selecteren en vervolgens bekend te maken
updatestage:concept-issue a elmo:Production;
	elmo:contains stage:DSOv2Beheermenu;
	elmo:contains stage:search-concepts-under-development;
	elmo:queryForm stage:DSOv2IssueConceptsForm;
	elmo:contains stage:IssueConceptScene;
.

updatestage:concept-enact a elmo:Production;
  elmo:contains stage:DSOv2Beheermenu;
	elmo:contains stage:search-concepts-nonenacted;
	elmo:queryForm stage:DSOv2EnactConceptsForm;
	elmo:contains stage:EnactConceptScene;
  elmo:contains stage:DeprecatePreviousVersion
.

#
# FORMS
#

stage:DSOv2IssueConceptsForm a elmo:Form;
	rdfs:label "Selecteer concept";
	elmo:index "1";
	elmo:fragment [
		elmo:applies-to "concept";
		rdfs:label "Selecteer concept"@nl;
		elmo:valuesFrom stage:search-concepts-under-development;
		elmo:constraint elmo:MandatoryConstraint;
		elmo:index "1";
	];
	elmo:fragment [
		elmo:appearance elmo:SubmitAppearance;
		rdfs:label "Ga verder"@nl;
		elmo:index "2";
	];
.

stage:DSOv2EnactConceptsForm a elmo:Form;
	rdfs:label "Selecteer concept";
	elmo:index "1";
	elmo:fragment [
		elmo:applies-to "graph";
		rdfs:label "Selecteer concept"@nl;
		elmo:valuesFrom stage:search-concepts-nonenacted;
		elmo:constraint elmo:MandatoryConstraint;
		elmo:index "1";
	];
	elmo:fragment [
		elmo:appearance elmo:SubmitAppearance;
		rdfs:label "Ga verder"@nl;
		elmo:index "3";
	];
.

#
# PARTS
#

stage:search-concepts-under-development a elmo:Part;
	elmo:appearance elmo:HiddenAppearance;
	elmo:query '''
		prefix prov: <http://www.w3.org/ns/prov#>
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix adms: <http://www.w3.org/ns/adms#>
		prefix sparql: <http://www.w3.org/ns/sparql-service-description>
    prefix adms-status: <http://purl.org/adms/status/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    prefix wdrs: <http://www.w3.org/2007/05/powder-s#>
    
		CONSTRUCT {
			?concept rdfs:label ?label
		}
		WHERE {
			GRAPH ?g {
				?concept rdf:type skos:Concept;
          wdrs:describedBy ?doc.
          
        ?doc adms:status adms-status:UnderDevelopment.
    		BIND( str(?concept) AS ?label )
			}
      FILTER regex( ?g, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
      FILTER NOT EXISTS {
        GRAPH ?docg {
          {
            ?newdoc prov:wasRevisionOf ?doc.
          }
          UNION
          {
            ?doc adms:status ?status.
            FILTER( ?status != adms-status:UnderDevelopment )
          }
        }
        FILTER regex( ?docg, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
      }
		}
	''';
.

stage:search-concepts-nonenacted a elmo:Part;
	elmo:appearance elmo:HiddenAppearance;
	elmo:query '''
		prefix prov: <http://www.w3.org/ns/prov#>
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix adms: <http://www.w3.org/ns/adms#>
		prefix sparql: <http://www.w3.org/ns/sparql-service-description>
    prefix adms-status: <http://purl.org/adms/status/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    prefix wdrs: <http://www.w3.org/2007/05/powder-s#>
    
		CONSTRUCT {
			?g rdfs:label ?label
		}
		WHERE {
      {
        GRAPH ?g {
          ?concept rdf:type skos:Concept;
            wdrs:describedBy ?doc.
        }
        FILTER regex( ?g, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
        GRAPH ?docGraph {
          ?doc rdf:type prov:Entity;
            adms:status adms-status:UnderDevelopment.

          ?docGraph prov:generatedAtTime ?docGraphTime.       
          FILTER NOT EXISTS {
            GRAPH ?newerDocGraph {
              ?doc rdf:type prov:Entity.
              ?newerDocGraph prov:generatedAtTime ?newerDocGraphTime.
              FILTER ( ?newerDocGraphTime > ?docGraphTime )            
            }
          }
        }
        BIND( concat( str( ?concept ), " (Under development)" ) AS ?label )
        FILTER NOT EXISTS {
          GRAPH ?otherGraph {
            ?concept rdf:type skos:Concept;
              wdrs:describedBy ?otherDoc.
          }
          FILTER regex( ?g, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
          GRAPH ?otherDocGraph {
            ?otherDoc rdf:type prov:Entity;
              adms:status adms-status:UnderDevelopment.

            ?otherDocGraph prov:generatedAtTime ?otherDocGraphTime.       
            FILTER NOT EXISTS {
              GRAPH ?newerOtherDocGraph {
                ?otherDoc rdf:type prov:Entity.
                ?newerOtherDocGraph prov:generatedAtTime ?newerOtherDocGraphTime.
                FILTER ( ?newerOtherDocGraphTime > ?otherDocGraphTime )            
              }
            }
          }
          FILTER( ?otherDocGraphTime > ?docGraphTime )
        }
      }
      UNION
      {
        GRAPH ?g {
          ?concept rdf:type skos:Concept;
            wdrs:describedBy ?doc.
        }
        FILTER regex( ?g, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
        GRAPH ?docGraph {
          ?doc rdf:type prov:Entity;
            adms:status skos-lex-status:Issued.

          ?docGraph prov:generatedAtTime ?docGraphTime.       
          FILTER NOT EXISTS {
            GRAPH ?newerDocGraph {
              ?doc rdf:type prov:Entity.
              ?newerDocGraph prov:generatedAtTime ?newerDocGraphTime.
              FILTER ( ?newerDocGraphTime > ?docGraphTime )            
            }
          }
        }
        BIND( concat( str( ?concept ), " (Issued)" ) AS ?label )
      }
		}
	''';
.


#
# SCENES
#

stage:IssueConceptScene a elmo:Scene;
	elmo:index "1";
	rdfs:label "Maak begrip bekend";
	elmo:query '''
    prefix prov: <http://www.w3.org/ns/prov#>
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix adms: <http://www.w3.org/ns/adms#>
		prefix sparql: <http://www.w3.org/ns/sparql-service-description/>
    prefix adms-status: <http://purl.org/adms/status/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    prefix wdrs: <http://www.w3.org/2007/05/powder-s#>
    prefix dcterms: <http://purl.org/dc/terms/>
    
    prefix container: <http://localhost:8080/catalogus/dsov2/container/>
		
    INSERT {
      GRAPH ?transactie {      
        ?transactie rdf:type sparql:Graph;
          rdfs:label "Bekendmaking van het begrip in de LVBB, en de registratie hiervan in de Catalogus";
          prov:generatedAtTime ?now.

        ?doc rdf:type prov:Entity;
          prov:wasRevisionOf ?prevDoc;
          adms:status skos-lex-status:Issued;
          dcterms:issued ?date.
      }
    }
    WHERE {
      GRAPH ?graph {
        <@CONCEPT@> wdrs:describedBy ?doc.
      }
      FILTER regex( ?graph, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
      OPTIONAL {
        GRAPH ?docGraph {
          ?doc prov:wasRevisionOf ?prevDoc.
        }
        FILTER regex( ?graph, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
      }
      FILTER NOT EXISTS {
        ?newdoc prov:wasRevisionOf ?doc.
      }
      
      BIND( strdt( concat(  year( now() ), "-", month( now() ), "-", day( now() ) ), xsd:date ) AS ?date )
      BIND( iri( concat( "http://omgevingswet.overheid.nl/catalogus/id/transactie/", replace( now(), " ", "T" ) ) ) AS ?transactie )
      BIND( now() AS ?now )
    }
	'''
.

stage:DeprecatePreviousVersion a elmo:Scene;
	elmo:index "1";
	rdfs:label "Update geldigheidstermijn eventuele andere geldige versie";
	elmo:query '''
    prefix prov: <http://www.w3.org/ns/prov#>
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix adms: <http://www.w3.org/ns/adms#>
		prefix sparql: <http://www.w3.org/ns/sparql-service-description/>
    prefix adms-status: <http://purl.org/adms/status/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    prefix wdrs: <http://www.w3.org/2007/05/powder-s#>
    prefix dcterms: <http://purl.org/dc/terms/>
    
    prefix container: <http://localhost:8080/catalogus/dsov2/container/>
    
    INSERT {
      GRAPH ?docGraph {
        ?prevDoc dcterms:valid ?newValidDate.
      }
    }
    WHERE {
      GRAPH ?currentTransaction {
        ?concept wdrs:describedBy ?doc.
      }
      GRAPH <@GRAPH@> {
        ?doc rdf:type prov:Entity.
      }
      GRAPH ?previousTransaction {
        ?concept wdrs:describedBy ?prevDoc.
      }
      GRAPH ?docGraph {
        ?prevDoc dcterms:valid ?currentValidDate.
        BIND( concat( ?currentValidDate, year( now() ), "-", month( now() ), "-", day( now() ) ) AS ?newValidDate )
        FILTER regex( ?currentValidDate, ".*/$" )
      }
    }
    
    DELETE {
      GRAPH ?docGraph {
        ?prevDoc dcterms:valid ?date.
      }
    }
    WHERE {
      GRAPH ?currentTransaction {
        ?concept wdrs:describedBy ?doc.
      }
      GRAPH <@GRAPH@> {
        ?doc rdf:type prov:Entity.
      }
      GRAPH ?previousTransaction {
        ?concept wdrs:describedBy ?prevDoc.
      }
      GRAPH ?docGraph {
        ?prevDoc dcterms:valid ?date.
        FILTER regex( ?date, ".*/$" )
      }
    }
  '''
.

stage:EnactConceptScene a elmo:Scene;
	elmo:index "3";
	rdfs:label "Laat gekozen versie van concept in werking treden";
	elmo:query '''
    prefix prov: <http://www.w3.org/ns/prov#>
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix adms: <http://www.w3.org/ns/adms#>
		prefix sparql: <http://www.w3.org/ns/sparql-service-description/>
    prefix adms-status: <http://purl.org/adms/status/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    prefix wdrs: <http://www.w3.org/2007/05/powder-s#>
    prefix dcterms: <http://purl.org/dc/terms/>
    
    prefix container: <http://localhost:8080/catalogus/dsov2/container/>
		
    INSERT {
      GRAPH ?transactie {      
        ?transactie rdf:type sparql:Graph;
          rdfs:label "In werking treding van het begrip";
          prov:generatedAtTime ?now.

        ?doc ?p ?o;
          adms:status skos-lex-status:Enacted;
          dcterms:valid ?validDate.
      }
    }
    WHERE {
      GRAPH <@GRAPH@> {
        ?doc rdf:type prov:Entity;
          ?p ?o.
        FILTER(
          ?p != adms:status
        )
      }
      BIND( iri( concat( "http://omgevingswet.overheid.nl/catalogus/id/transactie/", replace( now(), " ", "T" ) ) ) AS ?transactie )
      BIND( concat( year( now() ), "-", month( now() ), "-", day( now() ) , "/" ) AS ?validDate )
      BIND( now() AS ?now )
    }
	'''
.