#
#
#
# BEHEER WAARDELIJSTEN
#
#
#

#
# CONTAINERS
#

# Uploadcontainer voor waarden in waardelijst
container:waarden-post a elmo:Container;
  rdfs:label "Upload waarden om toe te voegen aan waardelijst";
  elmo:representation elmo:UploadRepresentation;
  elmo:contains stage:DSOv2Beheermenu;
	elmo:contains stage:DSOv2Header;
	elmo:contains stage:DSOv2Footer;
	elmo:replaces container:generiek;
  elmo:assertion [
		rdfs:label "De upload mag geen triples met skos:inScheme als predicate bevatten.";
		elmo:assert-not '''
			prefix container: <http://localhost:8080/catalogus/dsov2/container/>
			prefix dcat: <http://www.w3.org/ns/dcat#>
			ASK {
				GRAPH container:generiek {
					?s skos:inScheme ?scheme.
				}
			}
		''';
	];
.


#
# PRODUCTIONS
#

# Sync van waarden naar waardelijst
updatestage:syncwaarden a elmo:Production;
  elmo:contains stage:DSOv2Beheermenu;
	elmo:contains stage:DSOv2Header;
	elmo:contains stage:DSOv2Footer;
	elmo:queryForm stage:PostWaardenForm;
	elmo:contains stage:PrepareClassificerendScene;
	elmo:contains stage:PrepareCategoriserendScene;
	elmo:contains stage:PrepareRefererendScene;
  elmo:contains stage:ResourcePostScene;
	elmo:contains stage:GarbageCollectionScene;
  elmo:contains stage:WaardelijstenList;
.

stage:PostWaardenForm a elmo:Form;
	rdfs:label "Sync waarden naar waardelijst";
  elmo:index "2";
  elmo:fragment [
      elmo:applies-to "oin";
      rdfs:label "OIN"@nl;
      elmo:constraint elmo:MandatoryConstraint;
      elmo:index "1";
  ];
  elmo:fragment [
      elmo:applies-to "dataset";
      rdfs:label "Dataset"@nl;
      elmo:constraint elmo:MandatoryConstraint;
      elmo:index "2";
  ];
  elmo:fragment [
      elmo:applies-to "waardelijst";
      rdfs:label "Selecteer de waardelijst"@nl;
      elmo:valuesFrom stage:WaardelijstenList;
      elmo:constraint elmo:MandatoryConstraint;
      elmo:index "3";
  ];
  elmo:fragment [
      elmo:appearance elmo:SubmitAppearance;
      rdfs:label "Ga verder"@nl;
      elmo:index "4";
  ]
.

stage:WaardelijstenList a elmo:Part;
  elmo:appearance elmo:HiddenAppearance;
  elmo:query '''
    prefix def:     <http://catalogus.test.kadaster.nl/def/>
    prefix rdfs: 		<http://www.w3.org/2000/01/rdf-schema#>
    prefix sh: 		  <http://www.w3.org/ns/shacl#>
        
    CONSTRUCT {
      ?waardelijst rdfs:label ?waardelijst_label
    }
    WHERE {
      GRAPH def:Waardelijsten {
        ?waardelijst rdf:type sh:NodeShape;
          rdfs:label ?waardelijst_label
        .
      }
    }
  ''';
.

#
# SCENES
#

stage:PrepareClassificerendScene a elmo:Scene;
  rdfs:label "Klaarzetten data voor classificerende waardelijst";
  elmo:index "01";
  elmo:query '''
    prefix adms:            <http://www.w3.org/ns/adms#>
    prefix adms-status:     <http://purl.org/adms/status/>
    prefix dcterms:    		  <http://purl.org/dc/terms/>
    prefix foaf: 	  		    <http://xmlns.com/foaf/0.1/>
    prefix prov:            <http://www.w3.org/ns/prov#>
    prefix sd:              <http://www.w3.org/ns/sparql-service-description/>
    prefix sh: 		          <http://www.w3.org/ns/shacl#>
    prefix skos:            <http://www.w3.org/2004/02/skos/core#>
    prefix skoslex:         <http://bp4mc2.org/def/skos-lex/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    
    prefix container:       <http://localhost:8080/catalogus/dsov2/container/>
    prefix def:             <http://catalogus.test.kadaster.nl/def/>
    prefix user:            <http://catalogus.test.kadaster.nl/users/>
    
    INSERT {
      GRAPH container:generiek {
        ?collection rdf:type skos:Collection;
          rdfs:label ?name;
          skos:prefLabel ?name;
          skos:member ?s;
          skos:member ?member
        .
      }
    }
    WHERE {
      GRAPH container:generiek {
        ?s rdf:type skos:Concept.
      }
      GRAPH def:Waardelijsten {
        <@WAARDELIJST@> rdf:type sh:NodeShape;
          rdfs:label ?name;
          sh:property [
            sh:path [ sh:inversePath skos:member ];
            sh:hasValue ?collection
          ]
        .
      }
      OPTIONAL {
        GRAPH ?graph {       
          ?collection skos:member ?member.
          ?graph prov:generatedAtTime ?graphTime.
          FILTER NOT EXISTS {
            GRAPH ?newerGraph {
              ?newerGraph prov:generatedAtTime ?newerTime.
              ?collection rdf:type skos:Collection.
              FILTER( ?newerTime > ?graphTime )
            }
          }
        }
        FILTER regex( ?graph, "http://catalogus.test.kadaster.nl/id/transactie/" )
      }
    }
  '''
.

stage:PrepareCategoriserendScene a elmo:Scene;
  rdfs:label "Klaarzetten data voor categoriserende waardelijst";
  elmo:index "02";
  elmo:query '''
    prefix adms:            <http://www.w3.org/ns/adms#>
    prefix adms-status:     <http://purl.org/adms/status/>
    prefix dcterms:    		  <http://purl.org/dc/terms/>
    prefix foaf: 	  		    <http://xmlns.com/foaf/0.1/>
    prefix prov:            <http://www.w3.org/ns/prov#>
    prefix sd:              <http://www.w3.org/ns/sparql-service-description/>
    prefix sh: 		          <http://www.w3.org/ns/shacl#>
    prefix skos:            <http://www.w3.org/2004/02/skos/core#>
    prefix skoslex:         <http://bp4mc2.org/def/skos-lex/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    
    prefix container:       <http://localhost:8080/catalogus/dsov2/container/>
    prefix def:             <http://catalogus.test.kadaster.nl/def/>
    prefix user:            <http://catalogus.test.kadaster.nl/users/>
    
    INSERT {
      GRAPH container:generiek {
        ?s skos:inScheme ?scheme.
      }
    }
    WHERE {
      GRAPH container:generiek {
        ?s rdf:type skos:Concept.
      }
      GRAPH def:Waardelijsten {
        <@WAARDELIJST@> rdf:type sh:NodeShape;
          rdfs:label ?name;
          sh:property [
            sh:path skos:inScheme;
            sh:hasValue ?scheme
          ]
        .
      }
    }
  '''
.

stage:PrepareRefererendScene a elmo:Scene;
  rdfs:label "Klaarzetten data voor refererende waardelijst";
  elmo:index "03";
  elmo:query '''
    prefix adms:            <http://www.w3.org/ns/adms#>
    prefix adms-status:     <http://purl.org/adms/status/>
    prefix dcterms:    		  <http://purl.org/dc/terms/>
    prefix foaf: 	  		    <http://xmlns.com/foaf/0.1/>
    prefix prov:            <http://www.w3.org/ns/prov#>
    prefix sd:              <http://www.w3.org/ns/sparql-service-description/>
    prefix sh: 		          <http://www.w3.org/ns/shacl#>
    prefix skos:            <http://www.w3.org/2004/02/skos/core#>
    prefix skoslex:         <http://bp4mc2.org/def/skos-lex/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    
    prefix container:       <http://localhost:8080/catalogus/dsov2/container/>
    prefix def:             <http://catalogus.test.kadaster.nl/def/>
    prefix user:            <http://catalogus.test.kadaster.nl/users/>
    
    INSERT {
      GRAPH container:generiek {
        ?s rdf:type ?class.
      }
    }
    WHERE {
      GRAPH container:generiek {
        ?s rdf:type ?type.
      }
      GRAPH def:Waardelijsten {
        <@WAARDELIJST@> rdf:type sh:NodeShape;
          rdfs:label ?name;
          sh:property [
            sh:path rdf:type;
            sh:hasValue ?class
          ]
        .
      }
    }
    
    DELETE {
      GRAPH container:generiek {
        ?s rdf:type ?type.
      }
    }
    WHERE {
      GRAPH container:generiek {
        ?s rdf:type ?type.
      }
      GRAPH def:Waardelijsten {
        <@WAARDELIJST@> rdf:type sh:NodeShape;
          rdfs:label ?name;
          sh:property [
            sh:path rdf:type;
            sh:hasValue ?class
          ]
        .
      }
      FILTER ( ?type != ?class )
    }
  '''
.

stage:GarbageCollectionScene a elmo:Scene;
  rdfs:label "Opruimen tijdelijks graphs";
  elmo:index "99";
  elmo:query '''
    prefix container:       <http://localhost:8080/catalogus/dsov2/container/>
    
    CLEAR GRAPH container:generiek
    CLEAR GRAPH container:waarden-post
    CLEAR GRAPH container:waarden-put
  '''
.

#-------------------------- deleten van specifieke waarden uit waardelijst

stage:ValuelistMemberList a elmo:Part;
  elmo:appearance elmo:HiddenAppearance;
  elmo:query '''
    prefix owl: 			<http://www.w3.org/2002/07/owl#>
    prefix rdfs: 			<http://www.w3.org/2000/01/rdf-schema#>
    
    CONSTRUCT {
      ?concept rdfs:label ?concept_label
    }
    WHERE {
      GRAPH ?g {
        ?waardelijst rdf:type sh:NodeShape.
        ?concept rdfs:label ?concept_label
        .
      }
    }
    
  ''';
.

# Delete waarden van waardelijst
updatestage:deletewaarden a elmo:Production;
  elmo:contains stage:DSOv2Beheermenu;
	elmo:contains stage:DSOv2Header;
	elmo:contains stage:DSOv2Footer;
	elmo:queryForm stage:DeleteWaardenForm;
	# elmo:contains stage:PostWaardenClassificerendScene;
	# elmo:contains stage:UpdateCollectionScene;
	# elmo:contains stage:PostWaardenCategoriserendScene;
  elmo:contains stage:DeleteWaardenRefererendScene;
  elmo:contains stage:GarbageCollectionScene;
  elmo:contains stage:WaardelijstenList;
  elmo:contains stage:ValuelistMemberList;
.



stage:DeleteWaardenForm a elmo:Form;
	rdfs:label "Verwijder waarden uit waardelijst";
  elmo:index "2";
  elmo:fragment [
      elmo:applies-to "waardelijst";
      rdfs:label "Selecteer de waardelijst"@nl;
      elmo:valuesFrom stage:WaardelijstenList;
      elmo:constraint elmo:MandatoryConstraint;
      elmo:index "3";
  ];
  elmo:fragment [
      elmo:applies-to "concept";
      rdfs:label "Selecteer concept"@nl;
      elmo:valuesFrom stage:ValuelistMemberList;
      elmo:constraint elmo:MandatoryConstraint;
      elmo:index "4";
  ];
.
  
  
  
  
#-----------------------------------------------------------------------------------------  
stage:DeleteWaardenRefererendScene a elmo:Scene;
  rdfs:label "Verwijder waarden uit refererende waardelijst";
  elmo:index "4";
  elmo:query '''
    prefix adms:            <http://www.w3.org/ns/adms#>
    prefix adms-status:     <http://purl.org/adms/status/>
    prefix dcterms:    		  <http://purl.org/dc/terms/>
    prefix foaf: 	  		    <http://xmlns.com/foaf/0.1/>
    prefix prov:            <http://www.w3.org/ns/prov#>
    prefix sd:              <http://www.w3.org/ns/sparql-service-description/>
    prefix sh: 		          <http://www.w3.org/ns/shacl#>
    prefix skos:            <http://www.w3.org/2004/02/skos/core#>
    prefix skoslex:         <http://bp4mc2.org/def/skos-lex/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    
    prefix container:       <http://localhost:8080/catalogus/dsov2/container/>
    prefix def:             <http://catalogus.test.kadaster.nl/def/>
    prefix user:            <http://catalogus.test.kadaster.nl/users/>
    
    DELETE {
      GRAPH ?transactie {
        ?transactie rdf:type sd:Graph, prov:Entity;
          skos:changeNote "Opslaan waarden voor refererende waardelijst";
          prov:generatedAtTime ?now;
          prov:wasAttributedTo user:TomcatUser
        .
        
        ?subject ?p ?o;
          foaf:isPrimaryTopicOf ?doc;
          rdf:type ?class
        .
        
        ?doc rdf:type prov:Entity;
          adms:status adms-status:UnderDevelopment
        .
      }
    }
    WHERE {
      GRAPH ?g {
        <@CONCEPT@> rdf:type skos:Concept;
          skos:prefLabel ?prefLabel;
          ?p ?o
        .
        FILTER ( ?p != rdf:type )
      }
      GRAPH def:Waardelijsten {
        <@WAARDELIJST@> rdf:type sh:NodeShape;
          rdfs:label ?name;
          sh:property [
            sh:path rdf:type;
            sh:hasValue ?class
          ]
        .
      }
      
      BIND( iri( concat( "http://catalogus.test.kadaster.nl/id/transactie/", replace( now(), " ", "T" ) ) ) AS ?transactie )
      # TODO: checken of onderstaande URI klopt!
      BIND( lcase( replace( replace( str( ?class ), ".+/", "" ), ".+#", "" ) ) AS ?typename )
      BIND( iri( concat( "http://content.tst.omgevingswet.overheid.nl/id/", ?typename, "/", ?prefLabel ) ) AS ?subject )
      BIND( iri ( concat(  "http://catalogus.test.kadaster.nl/id/entity/", replace( now(), " ", "T" ), "-", ?typename, "-", ?prefLabel ) ) AS ?doc )
      BIND( now() AS ?now )
    }  
  '''
.
