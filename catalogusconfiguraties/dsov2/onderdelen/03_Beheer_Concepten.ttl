#
#
#
# BEHEER CONCEPTEN
#
#
#

#
# CONTAINERS
#

# Twee soorten containers:
# POST
# 	- Voegt één of meerdere nieuwe begrippen toe
# 	- Geeft een foutmelding als één of meerdere van de geuploade begrippen al bestaan
# PUT
# 	- Update bestaande begrippen
#	- Geeft een foutmelding als één of meerdere van de geuploade begrippen nog niet bestaan
# 

# Upload Turtle API ------------------------------------------------------------------------------------------------------------------------------

# Container POST Turtle Concepten
container:concept-post-ttl a elmo:Container;
  # Onderdelen
  elmo:contains stage:DSOv2Beheermenu;
  
  # Weergave
  elmo:representation elmo:UploadRepresentation;
  rdfs:label "Voeg nieuw concept toe (.ttl)";
  
  # Data
  elmo:replaces container:generiek;
  elmo:query stage:DSOv2ConceptenPost;
.

# Container PUT Turtle Concepten
container:concept-put-ttl a elmo:Container;
  # Onderdelen
  elmo:contains stage:DSOv2Beheermenu;
  
  # Weergave
  elmo:representation elmo:UploadRepresentation;
  rdfs:label "Update bestaand concept (.ttl)";
  
  # Data
  elmo:replaces container:generiek;
  elmo:query stage:DSOv2ConceptenPut;
.

# Container voor aanvullen concept
container:concept-add-ttl a elmo:Container;
  # Onderdelen
  elmo:contains stage:DSOv2Beheermenu;
  
  # Weergave
  elmo:representation elmo:UploadRepresentation;
  rdfs:label "Vul bestaand concept aan (.ttl)";
  
  # Data
  elmo:replaces container:generiek;
  elmo:query stage:DSOv2ConceptenAdd;
.

#
# SCENES
#

stage:DSOv2ConceptenPost a elmo:Scene;
	rdfs:label "Query voor verwerken POST";
	elmo:query '''
		prefix prov: <http://www.w3.org/ns/prov#>
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix adms: <http://www.w3.org/ns/adms#>
		prefix sparql: <http://www.w3.org/ns/sparql-service-description/>
    prefix adms-status: <http://purl.org/adms/status/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    prefix wdrs: <http://www.w3.org/2007/05/powder-s#>
    
    prefix container: <http://localhost:8080/catalogus/dsov2/container/>
    prefix user: <http://omgevingswet.overheid.nl/catalogus/users/>
    
    INSERT {
      GRAPH ?transactie {
        ?transactie rdf:type sparql:Graph;
          rdfs:label "Reserveren van het begrip in de Catalogus";
          prov:generatedAtTime ?now
        .
        
        ?subject ?p ?o;
          wdrs:describedBy ?doc
        .
        
        ?doc rdf:type prov:Entity;
          adms:status adms-status:UnderDevelopment;
          prov:wasGeneratedBy ?activity
        .
        
        ?activity rdf:type prov:Activity;
          rdfs:label "Opvoeren nieuw begrip";
          prov:startedAtTime ?now;
          prov:wasAssociatedWith user:TomcatUser
        .
      }
    }
    WHERE {
      GRAPH container:generiek {
        ?s rdf:type skos:Concept;
          skos:prefLabel ?prefLabel;
          ?p ?o
        .
      }
      
      BIND( iri( concat( "http://omgevingswet.overheid.nl/catalogus/id/transactie/", replace( now(), " ", "T" ) ) ) AS ?transactie )
      BIND( iri( concat( "http://omgevingswet.overheid.nl/catalogus/id/activiteit/Opvoering_", replace( now(), " ", "T" ) ) ) AS ?activity )
      BIND( iri( concat( "http://regelgeving.omgevingswet.overheid.nl/id/concept/", ?prefLabel ) ) AS ?subject )
      BIND( iri ( concat(  "http://regelgeving.omgevingswet.overheid.nl/doc/", replace( now(), " ", "T" ), "/concept/", ?prefLabel ) ) AS ?doc )
      BIND( now() AS ?now )
    }
    
		CLEAR GRAPH container:generiek
    CLEAR GRAPH container:concept-post-ttl
	''';
.

stage:DSOv2ConceptenPut a elmo:Scene;
	rdfs:label "Query voor verwerken PUT";
	elmo:query '''
		prefix prov: <http://www.w3.org/ns/prov#>
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix adms: <http://www.w3.org/ns/adms#>
		prefix sparql: <http://www.w3.org/ns/sparql-service-description/>
    prefix adms-status: <http://purl.org/adms/status/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    prefix wdrs: <http://www.w3.org/2007/05/powder-s#>
    
    prefix container: <http://localhost:8080/catalogus/dsov2/container/>
    prefix user: <http://omgevingswet.overheid.nl/catalogus/users/>
		
    INSERT {
      GRAPH ?transactie {
        ?transactie rdf:type sparql:Graph;
          rdfs:label "Aanpassing van het begrip door het bevoegde gezag";
          prov:generatedAtTime ?now
        .
        
        ?s ?p ?o;
          wdrs:describedBy ?doc
        .
        
        ?doc rdf:type prov:Entity;
          adms:status adms-status:UnderDevelopment;
          prov:wasRevisionOf ?currentDoc;
          prov:wasGeneratedBy ?activity
        .
        
        ?udDoc ?docP ?docO;
          adms:status adms-status:Deprecated
        .
        
        ?activity rdf:type prov:Activity;
          rdfs:label "Aanpassen bestaand begrip (binnen besluit)";
          prov:startedAtTime ?now;
          prov:wasAssociatedWith user:TomcatUser
        .
      }
    }
    WHERE {
      GRAPH container:generiek {
        ?s ?p ?o.
      }
      GRAPH ?graph {       
        ?s wdrs:describedBy ?currentDoc;
          skos:prefLabel ?prefLabel.
        
        ?graph prov:generatedAtTime ?graphTime.
        FILTER NOT EXISTS {
          GRAPH ?newerGraph {
            ?newerGraph prov:generatedAtTime ?newerTime.
            ?s rdf:type skos:Concept.
            FILTER( ?newerTime > ?graphTime )
          }
        }
      }
      FILTER regex( ?graph, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
      
      OPTIONAL {
        GRAPH ?udGraph {
          ?s wdrs:describedBy ?udDoc.
          ?udDoc ?docP ?docO;
            adms:status adms-status:UnderDevelopment.
          FILTER( ?docP != adms:status )
          
          ?udGraph prov:generatedAtTime ?udGraphTime.       
          FILTER NOT EXISTS {
            GRAPH ?newerDocGraph {
              ?udDoc rdf:type prov:Entity.
              ?newerDocGraph prov:generatedAtTime ?newerDocGraphTime.
              FILTER ( ?newerDocGraphTime > ?udGraphTime )            
            }
          }
        }
        FILTER regex( ?udGraph, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
      }
      
      BIND( iri( concat( "http://omgevingswet.overheid.nl/catalogus/id/transactie/", replace( now(), " ", "T" ) ) ) AS ?transactie )
      BIND( iri( concat( "http://omgevingswet.overheid.nl/catalogus/id/activiteit/Aanpassing_", replace( now(), " ", "T" ) ) ) AS ?activity )
      BIND( iri ( concat(  "http://regelgeving.omgevingswet.overheid.nl/doc/", replace( now(), " ", "T" ), "/concept/", ?prefLabel ) ) AS ?doc )
      BIND( now() AS ?now )
    }
    
    CLEAR GRAPH container:generiek
    CLEAR GRAPH container:concept-put-ttl
  '''
.

stage:DSOv2ConceptenAdd a elmo:Scene;
	rdfs:label "Query voor verwerken aanvullen concept";
	elmo:query '''
		prefix prov: <http://www.w3.org/ns/prov#>
		prefix skos: <http://www.w3.org/2004/02/skos/core#>
		prefix skoslex: <http://bp4mc2.org/def/skos-lex/>
		prefix adms: <http://www.w3.org/ns/adms#>
		prefix sparql: <http://www.w3.org/ns/sparql-service-description/>
    prefix adms-status: <http://purl.org/adms/status/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    prefix wdrs: <http://www.w3.org/2007/05/powder-s#>
    
    prefix container: <http://localhost:8080/catalogus/dsov2/container/>
    prefix user: <http://omgevingswet.overheid.nl/catalogus/users/>
		
    INSERT {
      GRAPH ?transactie {
        ?transactie rdf:type sparql:Graph;
          rdfs:label "Aanvullen van een in werking zijnde begrip met buiten-besluit elementen";
          prov:generatedAtTime ?now
        .
        
        ?s ?p ?o;
          wdrs:describedBy ?doc;
          ?pred ?obj
        .
        
        ?doc ?docP ?docO;
          prov:wasRevisionOf ?currentDoc;
          prov:wasGeneratedBy ?activity
        .
        
        ?activity rdf:type prov:Activity;
          rdfs:label "Aanpassen bestaand begrip (buiten besluit)";
          prov:startedAtTime ?now;
          prov:wasAssociatedWith user:TomcatUser
        .
      }
    }
    WHERE {
      GRAPH container:generiek {
        ?s ?p ?o.
        
        FILTER(
          ?p != rdf:type
          && ?p != rdfs:label
          && ?p != skos:prefLabel
          && ?p != skos:definition
        )
      }
      GRAPH ?graph {
        ?s wdrs:describedBy ?currentDoc;
          skos:prefLabel ?prefLabel;
          ?pred ?obj
        .
        FILTER(
          ?pred != wdrs:describedBy
        )
          
        ?graph prov:generatedAtTime ?graphTime.
        FILTER NOT EXISTS {
          GRAPH ?newerGraph {
            ?newerGraph prov:generatedAtTime ?newerTime.
            ?s rdf:type skos:Concept;
              wdrs:describedBy ?newerDoc.
            FILTER( ?newerTime > ?graphTime )
          }
          GRAPH ?docNewerGraph {
            ?newerDoc adms:status skos-lex-status:Enacted
          }
        }
      }
      GRAPH ?docGraph {
        ?currentDoc adms:status skos-lex-status:Enacted;
          ?docP ?docO.
        FILTER (
          ?docP != prov:wasRevisionOf
          && ?docP != prov:wasGeneratedBy
        )
        
        ?docGraph prov:generatedAtTime ?docGraphTime.
        FILTER NOT EXISTS {
          GRAPH ?newerDocGraph {
            ?thisDoc adms:status skos-lex-status:Enacted.
            ?newerDocGraph prov:generatedAtTime ?newerDocGraphTime.
            FILTER( ?newerDocGraphTime > ?docGraphTime )
          }
        }
      }
      
      FILTER regex( ?graph, "http://omgevingswet.overheid.nl/catalogus/id/transactie/" )
      
      BIND( iri( concat( "http://omgevingswet.overheid.nl/catalogus/id/transactie/", replace( now(), " ", "T" ) ) ) AS ?transactie )
      BIND( iri( concat( "http://omgevingswet.overheid.nl/catalogus/id/activiteit/Aanpassing_", replace( now(), " ", "T" ) ) ) AS ?activity )
      BIND( iri ( concat(  "http://regelgeving.omgevingswet.overheid.nl/doc/", replace( now(), " ", "T" ), "/concept/", ?prefLabel ) ) AS ?doc )
      BIND( now() AS ?now )
    }
    
    CLEAR GRAPH container:generiek
    CLEAR GRAPH container:concept-add-ttl
  '''
.