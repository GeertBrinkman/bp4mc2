#
#
#
# BEHEER COLLECTION
#
#
#
#
# PRODUCTIONS
#

updatestage:deletewaardencollectie a elmo:Production;
  elmo:contains stage:DSOv2Beheermenu;
	elmo:contains stage:DSOv2Header;
	elmo:contains stage:DSOv2Footer;
	elmo:queryForm stage:DeleteWaardenCollectieForm;
  elmo:contains stage:SelectCollection;
  elmo:contains stage:CollectionMemberList;
  elmo:contains stage:ClearSingleMemberScene
.

stage:DeleteWaardenCollectieForm a elmo:Form;
	rdfs:label "Verwijder waarde uit collectie";
  elmo:index "2";
  elmo:fragment [
      elmo:applies-to "collectie";
      rdfs:label "Selecteer de collectielijst"@nl;
      elmo:valuesFrom stage:CollectieList;
      elmo:constraint elmo:MandatoryConstraint;
      elmo:index "3";
  ];
  elmo:fragment [
      elmo:applies-to "concept";
      rdfs:label "Selecteer het concept"@nl;
      elmo:valuesFrom stage:CollectionMemberList;
      elmo:constraint elmo:MandatoryConstraint;
      elmo:index "4";
  ];
  elmo:fragment [
      elmo:appearance elmo:SubmitAppearance;
      rdfs:label "Ga verder"@nl;
      elmo:index "5";
  ]
.

stage:CollectionMemberList a elmo:Part;
  elmo:appearance elmo:HiddenAppearance;
  elmo:query '''
    prefix owl: 			<http://www.w3.org/2002/07/owl#>
    prefix rdfs: 			<http://www.w3.org/2000/01/rdf-schema#>
    prefix prov:      <http://www.w3.org/ns/prov#>
    prefix skos:      <http://www.w3.org/2004/02/skos/core#>
    
    CONSTRUCT {
      ?concept rdfs:label ?concept_label
    }
    WHERE {
      GRAPH ?g {
        ?collectie  skos:member ?concept.
        ?concept rdfs:label ?concept_label.
        ?g prov:generatedAtTime ?gTime.
      
        FILTER NOT EXISTS {
          GRAPH ?newerGraph {
            ?collectie skos:member ?concept.
            ?concept rdfs:label ?concept_label.
            ?newerGraph prov:generatedAtTime ?newerTime.
            FILTER( ?newerTime > ?gTime )
          }
        }
      }
    } 
  ''';
.

stage:SelectCollection a elmo:Part;
	elmo:appearance elmo:HiddenAppearance;
	elmo:query '''
    prefix adms:            <http://www.w3.org/ns/adms#>
    prefix adms-status:     <http://purl.org/adms/status/>
    prefix dcat: 		        <http://www.w3.org/ns/dcat#>
    prefix dcmiperiod:      <http://dublincore.org/documents/2006/04/10/dcmi-period/>
    prefix dcterms:    		  <http://purl.org/dc/terms/>
    prefix foaf: 	  		    <http://xmlns.com/foaf/0.1/>
    prefix org:             <http://www.w3.org/TR/vocab-org#>
		prefix prov:            <http://www.w3.org/ns/prov#>
		prefix skos:            <http://www.w3.org/2004/02/skos/core#>
		
		CONSTRUCT {
			?collection rdfs:label ?label.
		}
		WHERE {
      {
        GRAPH ?collectionGraph {
          ?collection rdf:type skos:Collection;
           rdfs:label ?label;
            foaf:isPrimaryTopicOf ?doc
          .
          
          ?collectionGraph prov:generatedAtTime ?collectionGraphTime.       
          FILTER NOT EXISTS {
            GRAPH ?newerCollectionGraph {
              ?collection foaf:isPrimaryTopicOf ?docNewerCollection.
              ?newerCollectionGraph prov:generatedAtTime ?newerCollectionGraphTime.
              FILTER ( ?newerCollectionGraphTime > ?collectionGraphTime )            
            }
            GRAPH ?docNewerCollectionGraph {
              ?docNewerCollection adms:status adms-status:Completed;
                dcterms:temporal/dcmiperiod:start ?docNewerCollectionStart
              .
              FILTER( strdt( ?docNewerCollectionStart, xsd:dateTime ) <= now() )
              FILTER NOT EXISTS {
                ?docNewerCollection dcterms:temporal/dcmiperiod:end ?docNewerCollectionEnd.
                FILTER( strdt( ?docNewerCollectionEnd, xsd:dateTime ) < now() )
              }
              
              ?docNewerCollectionGraph prov:generatedAtTime ?docNewerCollectionTime.       
              FILTER NOT EXISTS {
                GRAPH ?newerDocNewerCollectionGraph {
                  ?docNewerCollection rdf:type prov:Entity.
                  ?newerDocNewerCollectionGraph prov:generatedAtTime ?newerDocNewerCollectionTime.
                  FILTER ( ?newerDocNewerCollectionTime > ?docNewerCollectionTime )            
                }
              }
            }
          }
        }
        FILTER regex( ?collectionGraph, "http://catalogus.test.kadaster.nl/id/transactie/" )
        GRAPH ?docGraph {
          ?doc rdf:type prov:Entity;
            adms:status adms-status:Completed
          .
          FILTER NOT EXISTS {
            ?doc dcterms:temporal/dcmiperiod:end ?end.
            FILTER( strdt( ?end, xsd:dateTime ) < now() )
          }
          
          ?docGraph prov:generatedAtTime ?docGraphTime.       
          FILTER NOT EXISTS {
            GRAPH ?newerDocGraph {
              ?doc rdf:type prov:Entity.
              ?newerDocGraph prov:generatedAtTime ?newerDocGraphTime.
              FILTER ( ?newerDocGraphTime > ?docGraphTime )            
            }
          }
        }
      } UNION {
        BIND( iri( "blank" ) AS ?collection )
        BIND( "(N/A)" AS ?label )
      }
		}
	'''
.



# Scene gebruikt voor het verwijderen alle de geslecteerde skos:member
stage:ClearSingleMemberScene a elmo:Scene;
	elmo:index "1";
	rdfs:label "Verwijder enkele member uit collectie";
	elmo:query '''
    prefix adms:            <http://www.w3.org/ns/adms#>
    prefix adms-status:     <http://purl.org/adms/status/>
    prefix dcat: 	  		    <http://www.w3.org/ns/dcat#>
    prefix dcterms:    		  <http://purl.org/dc/terms/>
    prefix foaf: 	  		    <http://xmlns.com/foaf/0.1/>
    prefix prov:            <http://www.w3.org/ns/prov#>
    prefix sd:              <http://www.w3.org/ns/sparql-service-description/>
    prefix skos:            <http://www.w3.org/2004/02/skos/core#>
    prefix skoslex:         <http://bp4mc2.org/def/skos-lex/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    
    prefix container:       <http://localhost:8080/catalogus/dsov2/container/>
    prefix user:            <http://catalogus.test.kadaster.nl/users/>
 
 INSERT {

      GRAPH ?transactie {
        ?transactie rdf:type sd:Graph, prov:Entity;
          skos:changeNote "Aanpassen van een resource in de Catalogus";
          prov:generatedAtTime ?now;
          prov:wasAttributedTo user:TomcatUser
        .
        <@COLLECTIE@>  ?p ?o;
          skos:member ?concept;
          foaf:isPrimaryTopicOf ?doc
          #skos:inScheme ?scheme
        .

        ?doc rdf:type prov:Entity;
          adms:status adms-status:UnderDevelopment;
          prov:wasRevisionOf ?currentDoc
        .

        ?udDoc ?docP ?docO;
          adms:status adms-status:Withdrawn
        .
      }
    }
  WHERE {

    GRAPH ?g {
      <@COLLECTIE@> ?p ?o;
        skos:member ?concept.
      <@COLLECTIE@> rdf:type ?type
        .

      FILTER( ?p != skos:inScheme )
      FILTER( ?p != skos:member )
      FILTER( ?concept != <@CONCEPT@>)
      ?g prov:generatedAtTime ?gTime.

        FILTER NOT EXISTS {
          GRAPH ?newerGraph {
            ?newerGraph prov:generatedAtTime ?newerTime.
            <@COLLECTIE@>  ?p ?o;
            skos:member ?concept.
            <@COLLECTIE@> rdf:type ?type.
            FILTER( ?newerTime > ?gTime )
          }
        }
      }
     FILTER regex( ?g, "http://catalogus.test.kadaster.nl/id/transactie/" )

      GRAPH ?graph {       
        <@COLLECTIE@>  foaf:isPrimaryTopicOf ?currentDoc.
          OPTIONAL{ 
            <@COLLECTIE@> skos:prefLabel ?prefLabel.
          }
          OPTIONAL{  
            <@COLLECTIE@> skos:inScheme ?scheme.
          }
 
        ?graph prov:generatedAtTime ?graphTime.

        FILTER NOT EXISTS {
          GRAPH ?newerGraph {
            ?newerGraph prov:generatedAtTime ?newerTime.
            <@COLLECTIE@> rdf:type ?type.
            FILTER( ?newerTime > ?graphTime )
          }
        }
      }

      FILTER regex( ?graph, "http://catalogus.test.kadaster.nl/id/transactie/" )

      OPTIONAL {

        GRAPH ?udGraph {
          <@COLLECTIE@>  foaf:isPrimaryTopicOf ?udDoc.
          ?udDoc ?docP ?docO;
            adms:status adms-status:UnderDevelopment
          .
          FILTER( ?docP != adms:status )    
          ?udGraph prov:generatedAtTime ?udGraphTime.         
          FILTER NOT EXISTS {
            GRAPH ?newerDocGraph {
              ?udDoc rdf:type prov:Entity.
              ?newerDocGraph prov:generatedAtTime ?newerDocGraphTime.
              FILTER ( ?newerDocGraphTime > ?udGraphTime )            
            }
          }
        } 
        FILTER regex( ?udGraph, "http://catalogus.test.kadaster.nl/id/transactie/" )
      }
      
      BIND( iri( concat( "http://catalogus.test.kadaster.nl/id/transactie/", replace( now(), " ", "T" ) ) ) AS ?transactie )
      BIND( lcase( replace( replace( str( ?type ), ".+/", "" ), ".+#", "" ) ) AS ?typename )
      BIND( IF( BOUND( ?title ), replace( ?title, " ", "" ), ?prefLabel ) AS ?label )
      BIND( iri ( concat(  "http://catalogus.test.kadaster.nl/id/entity/", replace( now(), " ", "T" ), "-", ?typename, "-", ?label ) ) AS ?doc )
      BIND( now() AS ?now )
    }


	'''
.

