#
#
#
# BEHEER COLLECTION
#
#
#
#
# PRODUCTIONS
#

updatestage:deletewaardencollectie a elmo:Production;
  elmo:contains stage:DSOv2Beheermenu;
	elmo:contains stage:DSOv2Header;
	elmo:contains stage:DSOv2Footer;
	elmo:queryForm stage:DeleteWaardenCollectieForm;
  elmo:contains stage:SelectCollection;
  elmo:contains stage:CollectionMemberList;
  elmo:contains stage:ClearSingleMemberScene
.

stage:DeleteWaardenCollectieForm a elmo:Form;
	rdfs:label "Verwijder waarde uit collectie";
  elmo:index "2";
  elmo:fragment [
      elmo:applies-to "collectie";
      rdfs:label "Selecteer de collectielijst"@nl;
      elmo:valuesFrom stage:CollectieList;
      elmo:constraint elmo:MandatoryConstraint;
      elmo:index "3";
  ];
  elmo:fragment [
      elmo:applies-to "concept";
      rdfs:label "Selecteer het concept"@nl;
      elmo:valuesFrom stage:CollectionMemberList;
      elmo:constraint elmo:MandatoryConstraint;
      elmo:index "4";
  ];
  elmo:fragment [
      elmo:appearance elmo:SubmitAppearance;
      rdfs:label "Ga verder"@nl;
      elmo:index "5";
  ]
.

stage:CollectionMemberList a elmo:Part;
  elmo:appearance elmo:HiddenAppearance;
  elmo:query '''
    prefix adms:            <http://www.w3.org/ns/adms#>
    prefix adms-status:     <http://purl.org/adms/status/>
    prefix dcmiperiod:      <http://dublincore.org/documents/2006/04/10/dcmi-period/>
    prefix dcterms:    		  <http://purl.org/dc/terms/>
    prefix foaf: 	  		    <http://xmlns.com/foaf/0.1/>
    prefix org:             <http://www.w3.org/TR/vocab-org#>
		prefix prov:            <http://www.w3.org/ns/prov#>
		prefix skos:            <http://www.w3.org/2004/02/skos/core#>
    
		CONSTRUCT {
			?concept rdfs:label ?concept_label
		}
		WHERE {
      #
      # Haakje is overbodig
      #
      {
        GRAPH ?orgGraph {
          ?collectie  skos:member ?concept.
          ?concept rdfs:label ?concept_label.        }
        #
        # Denk om je uitlijning. Blokhaak sluiten hierboven moet op een nieuwe regel.
        #
        FILTER regex( ?orgGraph, "http://catalogus.test.kadaster.nl/id/transactie/" )
        GRAPH ?docGraph {
          ?doc rdf:type prov:Entity;
            adms:status adms-status:Completed;
            dcterms:temporal/dcmiperiod:start ?start
          .
          FILTER( strdt( ?start, xsd:dateTime ) <= now() )
          FILTER NOT EXISTS {
            ?doc dcterms:temporal/dcmiperiod:end ?end.
            FILTER( strdt( ?end, xsd:dateTime ) < now() )
          }
          #
          # Dit patroon bevat nog een fout, maar die heb je meegekopieerd van mij dus dat kan ik je niet kwalijk nemen.
          # Ik heb de bugfix die ik elders al heb doorgevoerd, toegevoegd hieronder.
          #
          ?docGraph prov:generatedAtTime ?docTime.
          FILTER NOT EXISTS {
            GRAPH ?newerDocGraph {
              ?doc rdf:type prov:Entity.
              ?newerDocGraph prov:generatedAtTime ?newerDocTime.
              FILTER( ?newerDocTime > ?docTime )
          }
        }
      }
    }
 '''
.  

stage:SelectCollection a elmo:Part;
	elmo:appearance elmo:HiddenAppearance;
	elmo:query '''
    prefix adms:            <http://www.w3.org/ns/adms#>
    prefix adms-status:     <http://purl.org/adms/status/>
    prefix dcmiperiod:      <http://dublincore.org/documents/2006/04/10/dcmi-period/>
    prefix dcterms:    		  <http://purl.org/dc/terms/>
    prefix foaf: 	  		    <http://xmlns.com/foaf/0.1/>
    prefix org:             <http://www.w3.org/TR/vocab-org#>
		prefix prov:            <http://www.w3.org/ns/prov#>
		prefix skos:            <http://www.w3.org/2004/02/skos/core#>
		
		CONSTRUCT {
			?collectie rdfs:label ?label.
		}
		WHERE {
      {
        GRAPH ?orgGraph {
          ?collection rdf:type skos:Collection;
            rdfs:label ?label;
            foaf:isPrimaryTopicOf ?doc
          .
        }
        FILTER regex( ?orgGraph, "http://catalogus.test.kadaster.nl/id/transactie/" )
        GRAPH ?docGraph {
          ?doc rdf:type prov:Entity;
            adms:status adms-status:Completed;
            dcterms:temporal/dcmiperiod:start ?start
          .
          FILTER( strdt( ?start, xsd:dateTime ) <= now() )
          FILTER NOT EXISTS {
            ?doc dcterms:temporal/dcmiperiod:end ?end.
            FILTER( strdt( ?end, xsd:dateTime ) < now() )
          }
          #
          # Graag ook hieronder de bovenstaande bugfix doorvoeren
          #
        }
      } UNION {
      #
      # Vanwaar deze union?
      #
        BIND( iri( "blank" ) AS ?collectie )
        BIND( "(N/A)" AS ?label )
      }
		}
	'''
.


# Scene gebruikt voor het verwijderen alle de geslecteerde skos:member
stage:ClearSingleMemberScene a elmo:Scene;
	elmo:index "1";
	rdfs:label "Verwijder enkele member uit collectie";
	elmo:query '''
    prefix adms:            <http://www.w3.org/ns/adms#>
    prefix adms-status:     <http://purl.org/adms/status/>
    prefix dcat: 	  		    <http://www.w3.org/ns/dcat#>
    prefix dcterms:    		  <http://purl.org/dc/terms/>
    prefix foaf: 	  		    <http://xmlns.com/foaf/0.1/>
    prefix prov:            <http://www.w3.org/ns/prov#>
    prefix sd:              <http://www.w3.org/ns/sparql-service-description/>
    prefix skos:            <http://www.w3.org/2004/02/skos/core#>
    prefix skoslex:         <http://bp4mc2.org/def/skos-lex/>
    prefix skos-lex-status: <http://bp4mc2.org/skos-lex/status/>
    
    prefix container:       <http://localhost:8080/catalogus/dsov2/container/>
    prefix user:            <http://catalogus.test.kadaster.nl/users/>
 
   #
   # Denk om je uitlijning. De INSERT moet verder ingesprongen worden
   #
 INSERT {

      GRAPH ?transactie {
        ?transactie rdf:type sd:Graph, prov:Entity;
        #
        # Changenote aanpassen
        #
          skos:changeNote "Aanpassen van een resource in de Catalogus";
          prov:generatedAtTime ?now;
          prov:wasAttributedTo user:TomcatUser
        .
        <@COLLECTIE@>  ?p ?o;
          skos:member ?concept;
          foaf:isPrimaryTopicOf ?doc
          #skos:inScheme ?scheme
        .

        ?doc rdf:type prov:Entity;
          adms:status adms-status:UnderDevelopment;
          prov:wasRevisionOf ?currentDoc
        .

        ?udDoc ?docP ?docO;
          adms:status adms-status:Withdrawn
        .
      }
    }
  #
  # Uitlijning. Het hele onderstaande blok moet verder ingesprongen worden
  #
  WHERE {

    GRAPH ?g {
      #
      # Dit voldoet niet aan de coding guidelines. Triples samentrekken.
      # Bovendien: hier ontbreekt een triple: foaf:primaryTopicOf ?currentDoc.
      # Vraag: waarom hoort die triple hier thuis?
      #
      <@COLLECTIE@> ?p ?o;
        skos:member ?concept.
      <@COLLECTIE@> rdf:type ?type
        .

      #
      # Waarom dit filter?
      #
      FILTER( ?p != skos:inScheme )
      FILTER( ?p != skos:member )
      FILTER( ?concept != <@CONCEPT@>)
      
      ?g prov:generatedAtTime ?gTime.
      #
      # Let op je uitlijning
      #
        FILTER NOT EXISTS {
          GRAPH ?newerGraph {
            ?newerGraph prov:generatedAtTime ?newerTime.
            #
            # Waarom de onderstaande drie triples? Hint: je hebt er maar eentje nodig.
            # Vraag: met welk doel moeten we hier een triple opnemen met @COLLECTI@ als subject?
            #
            <@COLLECTIE@>  ?p ?o;
            skos:member ?concept.
            <@COLLECTIE@> rdf:type ?type.
            FILTER( ?newerTime > ?gTime )
          }
        }
      }
     FILTER regex( ?g, "http://catalogus.test.kadaster.nl/id/transactie/" )

     #
     # Wat ben je hier aan het doen, in dit blok??
     #
      GRAPH ?graph {       
        <@COLLECTIE@>  foaf:isPrimaryTopicOf ?currentDoc.
          OPTIONAL{ 
            <@COLLECTIE@> skos:prefLabel ?prefLabel.
          }
          OPTIONAL{  
            <@COLLECTIE@> skos:inScheme ?scheme.
          }
 
        ?graph prov:generatedAtTime ?graphTime.

        FILTER NOT EXISTS {
          GRAPH ?newerGraph {
            ?newerGraph prov:generatedAtTime ?newerTime.
            <@COLLECTIE@> rdf:type ?type.
            FILTER( ?newerTime > ?graphTime )
          }
        }
      }

      FILTER regex( ?graph, "http://catalogus.test.kadaster.nl/id/transactie/" )
      #
      # Voor de duidelijkheid: bovenstaande vraag geldt tot hier. De rest is correct.
      #

      OPTIONAL {
        GRAPH ?udGraph {
          <@COLLECTIE@>  foaf:isPrimaryTopicOf ?udDoc.
          ?udDoc ?docP ?docO;
            adms:status adms-status:UnderDevelopment
          .
          FILTER( ?docP != adms:status )    
          ?udGraph prov:generatedAtTime ?udGraphTime.         
          FILTER NOT EXISTS {
            GRAPH ?newerDocGraph {
              ?udDoc rdf:type prov:Entity.
              ?newerDocGraph prov:generatedAtTime ?newerDocGraphTime.
              FILTER ( ?newerDocGraphTime > ?udGraphTime )            
            }
          }
        } 
        FILTER regex( ?udGraph, "http://catalogus.test.kadaster.nl/id/transactie/" )
      }
      
      BIND( iri( concat( "http://catalogus.test.kadaster.nl/id/transactie/", replace( now(), " ", "T" ) ) ) AS ?transactie )
      BIND( lcase( replace( replace( str( ?type ), ".+/", "" ), ".+#", "" ) ) AS ?typename )
      BIND( IF( BOUND( ?title ), replace( ?title, " ", "" ), ?prefLabel ) AS ?label )
      BIND( iri ( concat(  "http://catalogus.test.kadaster.nl/id/entity/", replace( now(), " ", "T" ), "-", ?typename, "-", ?label ) ) AS ?doc )
      BIND( now() AS ?now )
    }


	'''
.

