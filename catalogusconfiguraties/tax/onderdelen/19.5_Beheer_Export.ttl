#
# PRODUCTION

# production om subset in named graph te plaatsen en te tonen voor download
updatestage:TaxExportConcepten a elmo:Production;
	elmo:contains stage:TaxBeheermenu;
	elmo:contains stage:TaxFooter;
	elmo:queryForm stage:TaxSelectDataset;
	elmo:contains stage:ExportSubsetBegrippenQueryScene;
.

stage:ExportSubsetBegrippenQueryScene rdf:type elmo:Part;
	elmo:url-pattern "/exportsubsetbegrippen(|/|\\..+)$";
	elmo:contains stage:TaxBeheermenu;
	elmo:contains stage:TaxFooter;
	elmo:appearance elmo:ContentAppearance;
	elmo:index "2";
	elmo:query '''
		prefix prov:	<http://www.w3.org/ns/prov#>
		prefix kddef:	<http://kadaster.basisregistraties.overheid.nl/som/def#>
		prefix kdstat:	<http://kadaster.basisregistraties.overheid.nl/id/status/>
		prefix doc:		<http://localhost:8080/catalogus/tax/concepten/doc/>
		prefix skos:	<http://www.w3.org/2004/02/skos/core#>
		prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>
		CONSTRUCT {
			?concept ?p ?o 
		}
		WHERE {
			GRAPH ?g {
				?concept ?p ?o .
				?concept kddef:status ?status.
				?concept skos:inScheme <@DATASET@>.
				FILTER NOT EXISTS {
					?concept prov:invalidatedAtTime ?time.
				}
				FILTER (
					?status = kdstat:Gevalideerd ||
					?status = kdstat:Geverifieerd
				)
				FILTER NOT EXISTS {
					{
						?o kddef:status kdstat:Afgekeurd.
					}
					UNION
					{
						?o kddef:status kdstat:Niet_beoordeeld.
					}
					UNION
					{
						?o kddef:status kdstat:Ter_afkeuring.
					}
					UNION
					{
						?o kddef:status kdstat:Ter_validatie.
					}
				}
			}
			GRAPH doc:mastergraph {
				?concept rdfs:isDefinedBy ?g
			}
		}
	'''
.

